"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[3589],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>m});var a=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=a.createContext({}),p=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},d=function(e){var n=p(e.components);return a.createElement(s.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},c=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),c=p(t),m=i,k=c["".concat(s,".").concat(m)]||c[m]||u[m]||r;return t?a.createElement(k,l(l({ref:n},d),{},{components:t})):a.createElement(k,l({ref:n},d))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,l=new Array(r);l[0]=c;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o.mdxType="string"==typeof e?e:i,l[1]=o;for(var p=2;p<r;p++)l[p]=t[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},8145:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>l,default:()=>u,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var a=t(7462),i=(t(7294),t(3905));const r={id:"build-performance-optimization",title:"Build performance optimization"},l=void 0,o={unversionedId:"features/build/build-performance-optimization",id:"features/build/build-performance-optimization",title:"Build performance optimization",description:"By default, Tramvai uses Webpack and Babel for the build process, which are not known for high performance. There are several options that require manual configuration and testing but can significantly improve build performance.",source:"@site/tmp-docs/03-features/015-build/06-performance-optimization.md",sourceDirName:"03-features/015-build",slug:"/features/build/build-performance-optimization",permalink:"/docs/features/build/build-performance-optimization",draft:!1,editUrl:"https://github.com/tramvaijs/tramvai/-/edit/master/docs/tmp-docs/03-features/015-build/06-performance-optimization.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{id:"build-performance-optimization",title:"Build performance optimization"},sidebar:"sidebar",previous:{title:"Feature usage linting",permalink:"/docs/features/build/polyfills-eslint"},next:{title:"Overview",permalink:"/docs/features/child-app/overview"}},s={},p=[{value:"Universal",id:"universal",level:2},{value:"Update source-map library",id:"update-source-map-library",level:3},{value:"SWC transpiler",id:"swc-transpiler",level:3},{value:"Lightningcss",id:"lightningcss",level:3},{value:"Prod build (CI)",id:"prod-build-ci",level:2},{value:"Separate builds",id:"separate-builds",level:3},{value:"Disable filesystem cache",id:"disable-filesystem-cache",level:3},{value:"Dev build (local)",id:"dev-build-local",level:2},{value:"Disable sourcemaps",id:"disable-sourcemaps",level:3},{value:"Disable checkAsyncTs",id:"disable-checkasyncts",level:3},{value:"Selective transpiling",id:"selective-transpiling",level:3},{value:"Single runtime chunk",id:"single-runtime-chunk",level:3},{value:"Worker threads for start command (Tramvai 6+)",id:"worker-threads-for-start-command-tramvai-6",level:3},{value:"Build performance analysis",id:"build-performance-analysis",level:2},{value:"Analyze",id:"analyze",level:3},{value:"Benchmark",id:"benchmark",level:3},{value:"Known build performance issues",id:"known-build-performance-issues",level:2},{value:"Barrel exports",id:"barrel-exports",level:3}],d={toc:p};function u({components:e,...n}){return(0,i.kt)("wrapper",(0,a.Z)({},d,n,{components:e,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"By default, Tramvai uses Webpack and Babel for the build process, which are not known for high performance. There are several options that require manual configuration and testing but can significantly improve build performance."),(0,i.kt)("h2",{id:"universal"},"Universal"),(0,i.kt)("h3",{id:"update-source-map-library"},"Update source-map library"),(0,i.kt)("p",null,"Use the latest version of ",(0,i.kt)("inlineCode",{parentName:"p"},"source-map"),"."),(0,i.kt)("p",null,"Source map generation has been sped up via Rust + WASM, but some dependencies still install older versions of ",(0,i.kt)("inlineCode",{parentName:"p"},"source-map")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"webpack-sources"),', causing the older, slower version to "bubble up."'),(0,i.kt)("p",null,"Explicitly install the newer versions in your project:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "source-map": "^0.7.4",\n  "webpack-sources": "^3.2.3"\n}\n')),(0,i.kt)("h3",{id:"swc-transpiler"},"SWC transpiler"),(0,i.kt)("p",null,"Use SWC instead of Babel - it's roughly 2\xd7 faster because it's written in Rust."),(0,i.kt)("p",null,"To enable it, add the dependency:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"npx tramvai add --dev @tramvai/swc-integration")),(0,i.kt)("p",null,"And update your ",(0,i.kt)("inlineCode",{parentName:"p"},"tramvai.json")," config:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'"experiments": {\n  "transpilation": {\n    "loader": "swc"\n  }\n}\n')),(0,i.kt)("p",null,"If you have issues building with SWC or concerns about its impact on production, you can enable SWC only locally:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'"experiments": {\n  "transpilation": {\n    "loader": {\n      "development": "swc",\n      "production": "babel"\n    }\n  }\n}\n')),(0,i.kt)("h3",{id:"lightningcss"},"Lightningcss"),(0,i.kt)("p",null,"As an alternative, you can use Lightning CSS instead of PostCSS for transpilingby using the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/fz6m/lightningcss-loader"},"lightningcss-loader"),"."),(0,i.kt)("p",null,"LightningCSS is very limited in terms of functionality: it has few plugins and no configuration options when used as a loader."),(0,i.kt)("p",null,"To enable it, use the tramvai configuration:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'"experiments": {\n  "lightningcss": true\n}\n')),(0,i.kt)("h2",{id:"prod-build-ci"},"Prod build (CI)"),(0,i.kt)("h3",{id:"separate-builds"},"Separate builds"),(0,i.kt)("p",null,"Split the CI build into separate jobs:"),(0,i.kt)("p",null,"Server:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"tramvai build project -t server")),(0,i.kt)("p",null,"Client:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"tramvai build project -t client")),(0,i.kt)("p",null,"This can noticeably speed up the build thanks to parallel execution on separate hosts."),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"After the build, you must also copy ",(0,i.kt)("inlineCode",{parentName:"p"},"stats.json")," from the client build into the server build.")),(0,i.kt)("h3",{id:"disable-filesystem-cache"},"Disable filesystem cache"),(0,i.kt)("p",null,"Disable webpack\u2019s fileCache option \u2014 it only makes sense during local development. In CI, in most cases, there is no benefit in reusing the cache between builds or storing it."),(0,i.kt)("p",null,"In Tramvai 6+, it is disabled by default in CI."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"yarn tramvai build --fileCache=false")),(0,i.kt)("h2",{id:"dev-build-local"},"Dev build (local)"),(0,i.kt)("h3",{id:"disable-sourcemaps"},"Disable sourcemaps"),(0,i.kt)("p",null,"Source map generation significantly impacts build speed."),(0,i.kt)("p",null,"You can disable it in dev mode:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'"sourceMap": {\n  "development": false,\n  "production": true\n}\n')),(0,i.kt)("h3",{id:"disable-checkasyncts"},"Disable checkAsyncTs"),(0,i.kt)("p",null,"Type checking, despite running in a separate thread, still negatively affects build performance."),(0,i.kt)("p",null,"It is turned off by default and we do not recommend turning it on."),(0,i.kt)("h3",{id:"selective-transpiling"},"Selective transpiling"),(0,i.kt)("p",null,"By default, Tramvai performs partial transpilation of dependencies inside ",(0,i.kt)("inlineCode",{parentName:"p"},"node_modules"),"."),(0,i.kt)("p",null,"This mode is called ",(0,i.kt)("inlineCode",{parentName:"p"},"only-modern"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "experiments": {\n    "transpilation": {\n      "include": "only-modern"\n    }\n  }\n}\n')),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"only-modern")," is a special heuristic that tries to determine whether a dependency needs transpilation based on several signals."),(0,i.kt)("p",null,"However, locally you can disable transpilation entirely since local development is done in the latest version of the browser:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "experiments": {\n    "transpilation": {\n      "loader": "swc",\n      "include": {\n        "development": "none",\n        "production": "only-modern"\n      }\n    }\n  }\n}\n')),(0,i.kt)("p",null,"This speeds up the local build by 20-40% depending on the transpiler."),(0,i.kt)("p",null,"If you run into issues when disabling transpilation of ",(0,i.kt)("inlineCode",{parentName:"p"},"node_modules"),", you can explicitly list packages that must be transpiled:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "experiments": {\n    "transpilation": {\n      "loader": "swc",\n      "include": {\n        "development": ["@tinkoff/request", "@scope/package-name"],\n        "production": "only-modern"\n      }\n    }\n  }\n}\n')),(0,i.kt)("p",null,"Known packages that need to be transpiled due to the presence of ",(0,i.kt)("inlineCode",{parentName:"p"},"lazy()"),": ",(0,i.kt)("inlineCode",{parentName:"p"},"@tramvai/module-dev-tools"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"@tramvai-tinkoff/module-notifications")),(0,i.kt)("p",null,"If you have problems transpiling locally or in CI, you can enable transpilation for all ",(0,i.kt)("inlineCode",{parentName:"p"},"node_modules"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "experiments": {\n    "transpilation": {\n      "loader": "swc",\n      "include": {\n        "development": "all",\n        "production": "all"\n      }\n    }\n  }\n}\n')),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"It is recommended to avoid using ",(0,i.kt)("inlineCode",{parentName:"p"},"'all'")," because it severely degrades build performance.")),(0,i.kt)("h3",{id:"single-runtime-chunk"},"Single runtime chunk"),(0,i.kt)("p",null,"By default, webpack adds its runtime code to the main entrypoint chunk of the bundle \u2014 in our case, ",(0,i.kt)("inlineCode",{parentName:"p"},"platform.js"),"."),(0,i.kt)("p",null,"The problem with this approach is that when you make changes that affect an async chunk, webpack still has to rebuild the main chunk because the runtime code also changes."),(0,i.kt)("p",null,"To avoid unnecessary rebuilds of the main chunk, you can extract the runtime into a separate chunk:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "experiments": {\n    "runtimeChunk": "single"\n  }\n}\n')),(0,i.kt)("admonition",{type:"caution"},(0,i.kt)("p",{parentName:"admonition"},"This option affects proudction build and runtime performance, so perform performance measurements before enabling it.")),(0,i.kt)("h3",{id:"worker-threads-for-start-command-tramvai-6"},"Worker threads for start command (Tramvai 6+)"),(0,i.kt)("p",null,"Starting from version 6, Tramvai provides a new local development option:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"tramvai start --experimentalWebpackWorkerThreads")),(0,i.kt)("p",null,"It runs Webpack builds for both client and server in separate threads using ",(0,i.kt)("inlineCode",{parentName:"p"},"worker_threads"),", accelerating cold builds by 30-40%."),(0,i.kt)("h2",{id:"build-performance-analysis"},"Build performance analysis"),(0,i.kt)("p",null,"Tramvai includes special tooling for evaluating build performance via the commands ",(0,i.kt)("inlineCode",{parentName:"p"},"analyze")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"benchmark"),"."),(0,i.kt)("h3",{id:"analyze"},"Analyze"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"tramvai start --analyze=<plugin>")),(0,i.kt)("p",null,"Allowed plugin values: ",(0,i.kt)("inlineCode",{parentName:"p"},"rsdoctor"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"statoscope"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"bundle"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"whybundler"),"."),(0,i.kt)("p",null,"To analyze build performance, use ",(0,i.kt)("inlineCode",{parentName:"p"},"rsdoctor")),(0,i.kt)("p",null,"It shows statistics for all major build stages and detailed timing information for loaders and plugins."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"Rsdoctor")," works as a Webpack plugin and adds a small overhead to the build time. However, the Tramvai configuration of ",(0,i.kt)("inlineCode",{parentName:"p"},"rsdoctor")," is heavily optimized and adds only about 5-7%."),(0,i.kt)("p",null,"You can also run ",(0,i.kt)("inlineCode",{parentName:"p"},"analyze")," with the ",(0,i.kt)("inlineCode",{parentName:"p"},"build")," command:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"tramvai build --analyze=rsdoctor")),(0,i.kt)("h3",{id:"benchmark"},"Benchmark"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"tramvai bencmark <command>")),(0,i.kt)("p",null,"Allowed values: ",(0,i.kt)("inlineCode",{parentName:"p"},"start"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"build")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"benchmark")," provides more reliable measurements of current build performance."),(0,i.kt)("p",null,"By default, the build runs 3 times. Major build stages and the slowest loaders/plugins are measured, and then the results are averaged."),(0,i.kt)("p",null,"This produces less volatile timing data, which you can use to make informed decisions."),(0,i.kt)("h2",{id:"known-build-performance-issues"},"Known build performance issues"),(0,i.kt)("h3",{id:"barrel-exports"},"Barrel exports"),(0,i.kt)("p",null,"Some libraries may export their functionality using so-called barrel imports. This approach can significantly slow down build performance and can also lead to incorrect tree shaking."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://marvinh.dev/blog/speeding-up-javascript-ecosystem-part-7/"},"Good article")," about barrel imports."),(0,i.kt)("p",null,"We recommend checking your dependencies for such cases (this can be done using ",(0,i.kt)("inlineCode",{parentName:"p"},"tramvai analyze"),") with ",(0,i.kt)("inlineCode",{parentName:"p"},"rsdoctor")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"statoscope"),"."))}u.isMDXComponent=!0}}]);