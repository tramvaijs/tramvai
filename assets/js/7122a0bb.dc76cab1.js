"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[6824],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>c});var r=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function n(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?n(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,r,o=function(e,t){if(null==e)return{};var a,r,o={},n=Object.keys(e);for(r=0;r<n.length;r++)a=n[r],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(r=0;r<n.length;r++)a=n[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=r.createContext({}),m=function(e){var t=r.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},p=function(e){var t=m(e.components);return r.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var a=e.components,o=e.mdxType,n=e.originalType,s=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),u=m(a),c=o,h=u["".concat(s,".").concat(c)]||u[c]||d[c]||n;return a?r.createElement(h,l(l({ref:t},p),{},{components:a})):r.createElement(h,l({ref:t},p))}));function c(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var n=a.length,l=new Array(n);l[0]=u;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:o,l[1]=i;for(var m=2;m<n;m++)l[m]=a[m];return r.createElement.apply(null,l)}return r.createElement.apply(null,a)}u.displayName="MDXCreateElement"},8494:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>n,metadata:()=>i,toc:()=>m});var r=a(7462),o=(a(7294),a(3905));const n={title:"Memory leak"},l=void 0,i={unversionedId:"mistakes/memory-leak",id:"mistakes/memory-leak",title:"Memory leak",description:"In case you are facing critical errors for the server like FATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory than this is probably caused by memory leak in your app.",source:"@site/tmp-docs/mistakes/memory-leak.md",sourceDirName:"mistakes",slug:"/mistakes/memory-leak",permalink:"/docs/mistakes/memory-leak",draft:!1,editUrl:"https://github.com/tramvaijs/tramvai/-/edit/master/docs/tmp-docs/mistakes/memory-leak.md",tags:[],version:"current",frontMatter:{title:"Memory leak"},sidebar:"sidebar",previous:{title:"Duplicate dependencies",permalink:"/docs/mistakes/duplicate-dependencies"}},s={},m=[{value:"Local profiling",id:"local-profiling",level:2},{value:"Start the app",id:"start-the-app",level:3},{value:"Run server manually",id:"run-server-manually",level:4},{value:"Run start-prod command",id:"run-start-prod-command",level:4},{value:"Use the DevTools",id:"use-the-devtools",level:3},{value:"Test requests",id:"test-requests",level:3},{value:"What to look",id:"what-to-look",level:3},{value:"ChildContainer",id:"childcontainer",level:4},{value:"Summary",id:"summary",level:3},{value:"Example",id:"example",level:3}],p={toc:m};function d({components:e,...t}){return(0,o.kt)("wrapper",(0,r.Z)({},p,t,{components:e,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"In case you are facing critical errors for the server like ",(0,o.kt)("inlineCode",{parentName:"p"},"FATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory")," than this is probably caused by memory leak in your app."),(0,o.kt)("h2",{id:"local-profiling"},"Local profiling"),(0,o.kt)("p",null,"To find out root cause of the problem you need to analyze memory allocation on server over time."),(0,o.kt)("h3",{id:"start-the-app"},"Start the app"),(0,o.kt)("h4",{id:"run-server-manually"},"Run server manually"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Use this recipe for any server performance tests, results will be more stable than with ",(0,o.kt)("inlineCode",{parentName:"p"},"start-prod")," command")),(0,o.kt)("p",null,"Before, you need to make a production build:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai build <appName>\n")),(0,o.kt)("p",null,"After, with default options, application server bundle will be placed here - ",(0,o.kt)("inlineCode",{parentName:"p"},"dist/server/server.js"),", and client code in ",(0,o.kt)("inlineCode",{parentName:"p"},"dist/client")," directory."),(0,o.kt)("p",null,"Use this command to run application server:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"DANGEROUS_UNSAFE_ENV_FILES='true' DEV_STATIC='true' ASSETS_PREFIX='http://localhost:4000/dist/client/' node --inspect dist/server/server.js\n")),(0,o.kt)("p",null,"About env variables:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"DANGEROUS_UNSAFE_ENV_FILES")," force server to read env variables from ",(0,o.kt)("inlineCode",{parentName:"li"},"env.development.js")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"DEV_STATIC")," force server to run static server on ",(0,o.kt)("inlineCode",{parentName:"li"},"4000")," port (all folders from current directory will be served)"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"ASSETS_PREFIX")," points to client code folder on static server")),(0,o.kt)("h4",{id:"run-start-prod-command"},"Run start-prod command"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Fastest way to run production server, but not suitable for performance tests due to inaccuracies")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"You may use either ",(0,o.kt)("inlineCode",{parentName:"li"},"start")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"start-prod")," command to profile your app, but keep in mind that ",(0,o.kt)("inlineCode",{parentName:"li"},"start")," runs app in dev-environment that leads to higher memory consumption and additional code that may distract you from analyzing core logic of the app. However ",(0,o.kt)("inlineCode",{parentName:"li"},"start")," is preferred when you need to make code changes and you do not need to get the exact values of memory usage as for the prod-environment."),(0,o.kt)("li",{parentName:"ol"},"Using ",(0,o.kt)("inlineCode",{parentName:"li"},"@tramvai/cli")," you can pass a special flag ",(0,o.kt)("a",{parentName:"li",href:"/docs/references/cli/base#debug-an-app"},(0,o.kt)("inlineCode",{parentName:"a"},"--debug"))," and pass it either to the ",(0,o.kt)("inlineCode",{parentName:"li"},"start")," or ",(0,o.kt)("inlineCode",{parentName:"li"},"start-prod")," command"),(0,o.kt)("li",{parentName:"ol"},"You may pass any additional environment variables when calling cli commands as usual. For example, you may pass flag ",(0,o.kt)("a",{parentName:"li",href:"/docs/references/modules/http-client#http-client#how-to-disable-http-request-caching"},(0,o.kt)("inlineCode",{parentName:"a"},"HTTP_CLIENT_CACHE_DISABLED"))," to disable http cache."),(0,o.kt)("li",{parentName:"ol"},"To pass additional flags to the running nodejs instance you may use env ",(0,o.kt)("inlineCode",{parentName:"li"},"NODE_OPTIONS"),". E.g., if you want to limit the heap memory for the running server pass ",(0,o.kt)("inlineCode",{parentName:"li"},'NODE_OPTIONS="--max-old-space-size=256"')),(0,o.kt)("li",{parentName:"ol"},"If you are profiling using ",(0,o.kt)("inlineCode",{parentName:"li"},"start-prod")," with different env values without code changes you can use start-prod command that will reuse previous builds, e.g. ",(0,o.kt)("inlineCode",{parentName:"li"},"tramvai start-prod -t none app --debug"))),(0,o.kt)("h3",{id:"use-the-devtools"},"Use the DevTools"),(0,o.kt)("p",null,"After starting the app in debug mode you can open Chrome DevTools to be ready to take some profiling."),(0,o.kt)("p",null,"You may read more about how to profile memory leaks with Chrome in next links:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://medium.com/@basakabhijoy/debugging-and-profiling-memory-leaks-in-nodejs-using-chrome-e8ece4560dba#:~:text=Fire%20up%20the%20chrome%20browser"},"https://medium.com/@basakabhijoy/debugging-and-profiling-memory-leaks-in-nodejs-using-chrome-e8ece4560dba#:~:text=Fire%20up%20the%20chrome%20browser")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://developer.chrome.com/docs/devtools/memory-problems/#summary"},"https://developer.chrome.com/docs/devtools/memory-problems/#summary"))),(0,o.kt)("h3",{id:"test-requests"},"Test requests"),(0,o.kt)("p",null,"Most of the time memory leaks are happens for every request, so you need to do some request."),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Using browser go to the page that is handled by you app"),(0,o.kt)("li",{parentName:"ol"},"Use any additional tools to make a bunch of requests, e.g. ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/mcollina/autocannon"},"autocannon"))),(0,o.kt)("h3",{id:"what-to-look"},"What to look"),(0,o.kt)("p",null,"After you've started the app and took memory snapshots or memory allocations look for the data that stays in memory when it shouldn't."),(0,o.kt)("h4",{id:"childcontainer"},"ChildContainer"),(0,o.kt)("p",null,"In context of the tramvai app look for the ",(0,o.kt)("inlineCode",{parentName:"p"},"ChildContainer")," first as it is created for every request and contains the whole Request DI instance that consumes a lot of memory. It should be collected by the GC after request end, but sometimes some code may prevent it from collecting."),(0,o.kt)("h3",{id:"summary"},"Summary"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#start-the-app"},"Start the app")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#use-the-devtools"},"Start the DevTools")),(0,o.kt)("li",{parentName:"ol"},"Check memory usage on start and take the initial memory snapshot"),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("a",{parentName:"li",href:"#test-requests"},"Make some test requests")),(0,o.kt)("li",{parentName:"ol"},"Take another memory snapshot"),(0,o.kt)("li",{parentName:"ol"},"Compare two snapshots and ",(0,o.kt)("a",{parentName:"li",href:"#what-to-look"},"look for the leaks or unusual memory consumption"))),(0,o.kt)("h3",{id:"example"},"Example"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Start app in prod-mode ",(0,o.kt)("inlineCode",{parentName:"li"},"yarn tramvai start-prod travelaviasearch --debug")),(0,o.kt)("li",{parentName:"ol"},"Start Chrome DevTools"),(0,o.kt)("li",{parentName:"ol"},"Take the memory snapshot"),(0,o.kt)("li",{parentName:"ol"},"Execute requests with ",(0,o.kt)("inlineCode",{parentName:"li"},"autocannon -c 20 -d 60 localhost:3000/travel/flights/")),(0,o.kt)("li",{parentName:"ol"},"Click the button ",(0,o.kt)("inlineCode",{parentName:"li"},"Collect garbage")),(0,o.kt)("li",{parentName:"ol"},"Take another memory snapshot"),(0,o.kt)("li",{parentName:"ol"},"Compare two snapshots"),(0,o.kt)("li",{parentName:"ol"},"If you want to test app with other envs stop the server and close the DevTools, then run it again with ",(0,o.kt)("inlineCode",{parentName:"li"},'HTTP_CLIENT_CACHE_DISABLED=true MOCKER_ENABLED=true NODE_OPTIONS="--max-old-space-size=256" yarn tramvai start-prod -t none travelaviasearch'))))}d.isMDXComponent=!0}}]);