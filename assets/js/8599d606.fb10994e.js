"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[466],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return d}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),u=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),m=u(n),d=a,f=m["".concat(s,".").concat(d)]||m[d]||p[d]||o;return n?r.createElement(f,l(l({ref:t},c),{},{components:n})):r.createElement(f,l({ref:t},c))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,l=new Array(o);l[0]=m;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:a,l[1]=i;for(var u=2;u<o;u++)l[u]=n[u];return r.createElement.apply(null,l)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5162:function(e,t,n){n.d(t,{Z:function(){return l}});var r=n(7294),a=n(6010),o="tabItem_Ymn6";function l(e){let{children:t,hidden:n,className:l}=e;return r.createElement("div",{role:"tabpanel",className:(0,a.Z)(o,l),hidden:n},t)}},4866:function(e,t,n){n.d(t,{Z:function(){return N}});var r=n(7462),a=n(7294),o=n(6010),l=n(2466),i=n(6550),s=n(1980),u=n(7392),c=n(12);function p(e){return function(e){return a.Children.map(e,(e=>{if((0,a.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))}(e).map((e=>{let{props:{value:t,label:n,attributes:r,default:a}}=e;return{value:t,label:n,attributes:r,default:a}}))}function m(e){const{values:t,children:n}=e;return(0,a.useMemo)((()=>{const e=t??p(n);return function(e){const t=(0,u.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function d(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function f(e){let{queryString:t=!1,groupId:n}=e;const r=(0,i.k6)(),o=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,s._X)(o),(0,a.useCallback)((e=>{if(!o)return;const t=new URLSearchParams(r.location.search);t.set(o,e),r.replace({...r.location,search:t.toString()})}),[o,r])]}function k(e){const{defaultValue:t,queryString:n=!1,groupId:r}=e,o=m(e),[l,i]=(0,a.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!d({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const r=n.find((e=>e.default))??n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:t,tabValues:o}))),[s,u]=f({queryString:n,groupId:r}),[p,k]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[r,o]=(0,c.Nk)(n);return[r,(0,a.useCallback)((e=>{n&&o.set(e)}),[n,o])]}({groupId:r}),h=(()=>{const e=s??p;return d({value:e,tabValues:o})?e:null})();(0,a.useLayoutEffect)((()=>{h&&i(h)}),[h]);return{selectedValue:l,selectValue:(0,a.useCallback)((e=>{if(!d({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);i(e),u(e),k(e)}),[u,k,o]),tabValues:o}}var h=n(2389),b="tabList__CuJ",v="tabItem_LNqP";function y(e){let{className:t,block:n,selectedValue:i,selectValue:s,tabValues:u}=e;const c=[],{blockElementScrollPositionUntilNextRender:p}=(0,l.o5)(),m=e=>{const t=e.currentTarget,n=c.indexOf(t),r=u[n].value;r!==i&&(p(t),s(r))},d=e=>{var t;let n=null;switch(e.key){case"Enter":m(e);break;case"ArrowRight":{const t=c.indexOf(e.currentTarget)+1;n=c[t]??c[0];break}case"ArrowLeft":{const t=c.indexOf(e.currentTarget)-1;n=c[t]??c[c.length-1];break}}null==(t=n)||t.focus()};return a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.Z)("tabs",{"tabs--block":n},t)},u.map((e=>{let{value:t,label:n,attributes:l}=e;return a.createElement("li",(0,r.Z)({role:"tab",tabIndex:i===t?0:-1,"aria-selected":i===t,key:t,ref:e=>c.push(e),onKeyDown:d,onClick:m},l,{className:(0,o.Z)("tabs__item",v,null==l?void 0:l.className,{"tabs__item--active":i===t})}),n??t)})))}function g(e){let{lazy:t,children:n,selectedValue:r}=e;if(n=Array.isArray(n)?n:[n],t){const e=n.find((e=>e.props.value===r));return e?(0,a.cloneElement)(e,{className:"margin-top--md"}):null}return a.createElement("div",{className:"margin-top--md"},n.map(((e,t)=>(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==r}))))}function w(e){const t=k(e);return a.createElement("div",{className:(0,o.Z)("tabs-container",b)},a.createElement(y,(0,r.Z)({},e,t)),a.createElement(g,(0,r.Z)({},e,t)))}function N(e){const t=(0,h.Z)();return a.createElement(w,(0,r.Z)({key:String(t)},e))}},1814:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return s},default:function(){return d},frontMatter:function(){return i},metadata:function(){return u},toc:function(){return p}});var r=n(7462),a=(n(7294),n(3905)),o=n(4866),l=n(5162);const i={},s=void 0,u={unversionedId:"references/modules/mocker",id:"references/modules/mocker",title:"mocker",description:"Module uses library @tinkoff/mocker to add a mocker functionality to the tramvai app. Mocker will be available as papi route with path /mocker.",source:"@site/tmp-docs/references/modules/mocker.md",sourceDirName:"references/modules",slug:"/references/modules/mocker",permalink:"/docs/references/modules/mocker",draft:!1,editUrl:"https://github.com/tramvaijs/tramvai/-/edit/master/docs/tmp-docs/references/modules/mocker.md",tags:[],version:"current",frontMatter:{},sidebar:"sidebar",previous:{title:"micro-sentry",permalink:"/docs/references/modules/micro-sentry"},next:{title:"opentelemetry",permalink:"/docs/references/modules/opentelemetry"}},c={},p=[{value:"Installation",id:"installation",level:2},{value:"Explanation",id:"explanation",level:2},{value:"Env variables replacement",id:"env-variables-replacement",level:3},{value:"How to",id:"how-to",level:2},{value:"Mock only specific API",id:"mock-only-specific-api",level:3},{value:"Exported tokens",id:"exported-tokens",level:2}],m={toc:p};function d(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Module uses library ",(0,a.kt)("a",{parentName:"p",href:"/docs/references/libs/mocker"},"@tinkoff/mocker")," to add a mocker functionality to the ",(0,a.kt)("inlineCode",{parentName:"p"},"tramvai")," app. Mocker will be available as ",(0,a.kt)("a",{parentName:"p",href:"/docs/references/modules/server#papi"},"papi")," route with path ",(0,a.kt)("inlineCode",{parentName:"p"},"/mocker"),"."),(0,a.kt)("h2",{id:"installation"},"Installation"),(0,a.kt)("p",null,"First, install ",(0,a.kt)("inlineCode",{parentName:"p"},"@tramvai/module-mocker"),":"),(0,a.kt)(o.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"npm",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"npm install @tramvai/module-mocker\n"))),(0,a.kt)(l.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"yarn add @tramvai/module-mocker\n")))),(0,a.kt)("p",null,"Then, add your first mock to a new file ",(0,a.kt)("inlineCode",{parentName:"p"},"mocks/my-api.js"),". In this file add export of object literal with the field ",(0,a.kt)("inlineCode",{parentName:"p"},"api")," that should be specified as a name of environment variable for the API url that should be mocked:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx"},"module.exports = {\n  api: 'MY_API',\n  mocks: {\n    'GET /endpoint?foo=bar': {\n      status: 200,\n      headers: {},\n      payload: {\n        result: {\n          type: 'json',\n          value: {\n            a: 'b',\n          },\n        },\n      },\n    },\n  },\n};\n")),(0,a.kt)("p",null,"Add module to the project:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createApp } from '@tramvai/core';\nimport { MockerModule } from '@tramvai/module-mocker';\n\ncreateApp({\n  name: 'tincoin',\n  modules: [MockerModule],\n});\n")),(0,a.kt)("p",null,"Run app with env ",(0,a.kt)("inlineCode",{parentName:"p"},"MOCKER_ENABLED"),", e.g.:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'MOCKER_ENABLED="true" tramvai start tincoin\n')),(0,a.kt)("p",null,"After that, all of the requests to ",(0,a.kt)("inlineCode",{parentName:"p"},"MY_API")," in browser and on server will be automatically sent to mocker. In case mocker doesn't have a suitable mock the request, the request will be proxied to the original API."),(0,a.kt)("h2",{id:"explanation"},"Explanation"),(0,a.kt)("p",null,"Most of the mocker features are described in the ",(0,a.kt)("a",{parentName:"p",href:"/docs/references/libs/mocker#Explanation"},"lib documentation"),"."),(0,a.kt)("p",null,"Module adds mocker middleware to ",(0,a.kt)("inlineCode",{parentName:"p"},"papi")," route ",(0,a.kt)("inlineCode",{parentName:"p"},"/mocker")," and replaces all of the env variables that were defined in mocks by links to the ",(0,a.kt)("inlineCode",{parentName:"p"},"papi"),". After that all of the request to the original API are routed first to mocker that accepts requests from the client and the server side."),(0,a.kt)("p",null,"By default, all of the API that were defined mocks are mocked, but it might be overridden."),(0,a.kt)("p",null,"Mocker us enabled only when env variable ",(0,a.kt)("inlineCode",{parentName:"p"},"MOCKER_ENABLED")," is defined."),(0,a.kt)("h3",{id:"env-variables-replacement"},"Env variables replacement"),(0,a.kt)("p",null,"Let's say app has env variable ",(0,a.kt)("inlineCode",{parentName:"p"},"MY_API: https://www.my-api.com/")," and for that api some mock is defined."),(0,a.kt)("p",null,"The module can work locally, on dynamic stand, in test/stage environments. But this flexibility leads to the following problems when resolving path to the ",(0,a.kt)("inlineCode",{parentName:"p"},"papi")," endpoint:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"On server we should execute requests with absolute path. In this case we know that app is always available at ",(0,a.kt)("inlineCode",{parentName:"li"},"localhost")," that mean we can replace API env variables by urls like ",(0,a.kt)("inlineCode",{parentName:"li"},"http://localhost:3000/tincoin/papi/mocker/MY_API/")),(0,a.kt)("li",{parentName:"ol"},"On client test stands we do not known the domain of the app. In this case we should make requests by relative urls that mean we can replace API env variables by urls like ",(0,a.kt)("inlineCode",{parentName:"li"},"/tincoin/papi/mocker/MY_API/"))),(0,a.kt)("p",null,"Thanks to this env replacement we can redirect all of the request to the APIs to our mocker first automatically."),(0,a.kt)("h2",{id:"how-to"},"How to"),(0,a.kt)("h3",{id:"mock-only-specific-api"},"Mock only specific API"),(0,a.kt)("p",null,"By default, all of the API that has corresponding mock will be mocked. It might be overridden by passing list of the APIs to mock when initializing module:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx"},"MockerModule.forRoot({\n  config: async () => ({\n    apis: ['MY_API'],\n  }),\n});\n")),(0,a.kt)("h2",{id:"exported-tokens"},"Exported tokens"),(0,a.kt)("p",null,(0,a.kt)("pre",{parentName:"p"},(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { createToken } from '@tinkoff/dippy';\nimport type { Mocker, MockRepository } from '@tinkoff/mocker';\n\nexport interface MockerOptions {\n  apis: string[];\n}\n\nexport const MOCKER = createToken<Mocker>('MOCKER');\n\nexport const MOCKER_REPOSITORY = createToken<MockRepository>('MOCKER_REPOSITORY', {\n  multi: true,\n});\n\nexport const MOCKER_CONFIGURATION =\n  createToken<() => Promise<MockerOptions>>('MOCKER_CONFIGURATION');\n\n"))))}d.isMDXComponent=!0}}]);