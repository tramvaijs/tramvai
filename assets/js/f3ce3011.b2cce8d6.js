"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[259],{3905:function(e,n,t){t.d(n,{Zo:function(){return d},kt:function(){return m}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=a.createContext({}),p=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},d=function(e){var n=p(e.components);return a.createElement(s.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},c=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),c=p(t),m=r,b=c["".concat(s,".").concat(m)]||c[m]||u[m]||l;return t?a.createElement(b,i(i({ref:n},d),{},{components:t})):a.createElement(b,i({ref:n},d))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,i=new Array(l);i[0]=c;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=t[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},5162:function(e,n,t){t.d(n,{Z:function(){return i}});var a=t(7294),r=t(6010),l="tabItem_Ymn6";function i(e){let{children:n,hidden:t,className:i}=e;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(l,i),hidden:t},n)}},4866:function(e,n,t){t.d(n,{Z:function(){return y}});var a=t(7462),r=t(7294),l=t(6010),i=t(2466),o=t(6550),s=t(1980),p=t(7392),d=t(12);function u(e){return function(e){return r.Children.map(e,(e=>{if((0,r.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))}(e).map((e=>{let{props:{value:n,label:t,attributes:a,default:r}}=e;return{value:n,label:t,attributes:a,default:r}}))}function c(e){const{values:n,children:t}=e;return(0,r.useMemo)((()=>{const e=n??u(t);return function(e){const n=(0,p.l)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function m(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function b(e){let{queryString:n=!1,groupId:t}=e;const a=(0,o.k6)(),l=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,s._X)(l),(0,r.useCallback)((e=>{if(!l)return;const n=new URLSearchParams(a.location.search);n.set(l,e),a.replace({...a.location,search:n.toString()})}),[l,a])]}function k(e){const{defaultValue:n,queryString:t=!1,groupId:a}=e,l=c(e),[i,o]=(0,r.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!m({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const a=t.find((e=>e.default))??t[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:n,tabValues:l}))),[s,p]=b({queryString:t,groupId:a}),[u,k]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[a,l]=(0,d.Nk)(t);return[a,(0,r.useCallback)((e=>{t&&l.set(e)}),[t,l])]}({groupId:a}),f=(()=>{const e=s??u;return m({value:e,tabValues:l})?e:null})();(0,r.useLayoutEffect)((()=>{f&&o(f)}),[f]);return{selectedValue:i,selectValue:(0,r.useCallback)((e=>{if(!m({value:e,tabValues:l}))throw new Error(`Can't select invalid tab value=${e}`);o(e),p(e),k(e)}),[p,k,l]),tabValues:l}}var f=t(2389),h="tabList__CuJ",g="tabItem_LNqP";function N(e){let{className:n,block:t,selectedValue:o,selectValue:s,tabValues:p}=e;const d=[],{blockElementScrollPositionUntilNextRender:u}=(0,i.o5)(),c=e=>{const n=e.currentTarget,t=d.indexOf(n),a=p[t].value;a!==o&&(u(n),s(a))},m=e=>{var n;let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const n=d.indexOf(e.currentTarget)+1;t=d[n]??d[0];break}case"ArrowLeft":{const n=d.indexOf(e.currentTarget)-1;t=d[n]??d[d.length-1];break}}null==(n=t)||n.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,l.Z)("tabs",{"tabs--block":t},n)},p.map((e=>{let{value:n,label:t,attributes:i}=e;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:o===n?0:-1,"aria-selected":o===n,key:n,ref:e=>d.push(e),onKeyDown:m,onClick:c},i,{className:(0,l.Z)("tabs__item",g,null==i?void 0:i.className,{"tabs__item--active":o===n})}),t??n)})))}function v(e){let{lazy:n,children:t,selectedValue:a}=e;if(t=Array.isArray(t)?t:[t],n){const e=t.find((e=>e.props.value===a));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},t.map(((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==a}))))}function w(e){const n=k(e);return r.createElement("div",{className:(0,l.Z)("tabs-container",h)},r.createElement(N,(0,a.Z)({},e,n)),r.createElement(v,(0,a.Z)({},e,n)))}function y(e){const n=(0,f.Z)();return r.createElement(w,(0,a.Z)({key:String(n)},e))}},4961:function(e,n,t){t.r(n),t.d(n,{assets:function(){return d},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return o},metadata:function(){return p},toc:function(){return u}});var a=t(7462),r=(t(7294),t(3905)),l=t(4866),i=t(5162);const o={},s=void 0,p={unversionedId:"references/tools/build",id:"references/tools/build",title:"build",description:"Library for building production ready bundles for packages written in TypeScript targetting next environments:",source:"@site/tmp-docs/references/tools/build.md",sourceDirName:"references/tools",slug:"/references/tools/build",permalink:"/docs/references/tools/build",draft:!1,editUrl:"https://github.com/tramvaijs/tramvai/-/edit/master/docs/tmp-docs/references/tools/build.md",tags:[],version:"current",frontMatter:{},sidebar:"sidebar",previous:{title:"cli",permalink:"/docs/references/cli"},next:{title:"check-versions",permalink:"/docs/references/tools/check-versions"}},d={},u=[{value:"Installation",id:"installation",level:2},{value:"Get started",id:"get-started",level:2},{value:"Explanation",id:"explanation",level:2},{value:"NodeJS bundle in CommonJs format",id:"nodejs-bundle-in-commonjs-format",level:3},{value:"Bundle for bundlers (Webpack, etc.) in ES modules format",id:"bundle-for-bundlers-webpack-etc-in-es-modules-format",level:3},{value:"Bundle for browsers",id:"bundle-for-browsers",level:3},{value:"Copy static assets",id:"copy-static-assets",level:3},{value:"Build and copy migrations",id:"build-and-copy-migrations",level:3},{value:"CLI",id:"cli",level:2},{value:"Single build",id:"single-build",level:3},{value:"Build in watch mode",id:"build-in-watch-mode",level:3},{value:"Copy static assets",id:"copy-static-assets-1",level:3},{value:"Available flags",id:"available-flags",level:3},{value:"JavaScript API",id:"javascript-api",level:2},{value:"TramvaiBuild",id:"tramvaibuild",level:3},{value:"Build",id:"build",level:3},{value:"Copy static files",id:"copy-static-files",level:3},{value:"How to",id:"how-to",level:2},{value:"Build separate bundle for browsers",id:"build-separate-bundle-for-browsers",level:3},{value:"Replace specific module for browser bundle",id:"replace-specific-module-for-browser-bundle",level:3},{value:"Build all of the packages in monorepo in watch mode",id:"build-all-of-the-packages-in-monorepo-in-watch-mode",level:3},{value:"Import module only under some circumstances or put module to separate chunk",id:"import-module-only-under-some-circumstances-or-put-module-to-separate-chunk",level:3},{value:"Use JSON in package",id:"use-json-in-package",level:3},{value:"Use assets file in the package (e.g. css, svg)",id:"use-assets-file-in-the-package-eg-css-svg",level:3},{value:"Use css-modules",id:"use-css-modules",level:3},{value:"Build only migrations or tests",id:"build-only-migrations-or-tests",level:3}],c={toc:u};function m(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Library for building ",(0,r.kt)("inlineCode",{parentName:"p"},"production")," ready bundles for packages written in TypeScript targetting next environments:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"NodeJS"),(0,r.kt)("li",{parentName:"ul"},"Bundlers (Webpack, etc.)"),(0,r.kt)("li",{parentName:"ul"},"Browsers")),(0,r.kt)("h2",{id:"installation"},"Installation"),(0,r.kt)("p",null,"Install ",(0,r.kt)("inlineCode",{parentName:"p"},"@tramvai/build")," first:"),(0,r.kt)(l.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"npm",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"npm install --save-dev @tramvai/build\n"))),(0,r.kt)(i.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"yarn add --dev @tramvai/build\n")))),(0,r.kt)("h2",{id:"get-started"},"Get started"),(0,r.kt)("p",null,"Add necessary fields to ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "main": "lib/index.js",\n  "module": "lib/index.es.js",\n  "typings": "lib/index.d.ts",\n  "sideEffects": false,\n  "files": [\n    "lib"\n  ]\n}\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("inlineCode",{parentName:"p"},'"main": "lib/index.js"')," based on that field lib calculates entry point for the build and it will be ",(0,r.kt)("inlineCode",{parentName:"p"},'"src/index.ts"')," in this case")),(0,r.kt)("p",null,"Create ",(0,r.kt)("inlineCode",{parentName:"p"},"tsconfig.json"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "compilerOptions": {\n    "moduleResolution": "node",\n    "module": "ESNext",\n    "target": "ES2015",\n    "allowJs": true,\n    "declaration": true,\n    "sourceMap": true,\n    "importHelpers": true,\n    "resolveJsonModule": true,\n    "allowSyntheticDefaultImports": true,\n    "esModuleInterop": true,\n    "skipLibCheck": true,\n    "jsx": "react-jsx",\n    "rootDir": "./src",\n    "outDir": "./lib",\n    "declarationDir": "./lib",\n    "types": ["node"],\n    "lib": [\n      "es2015",\n      "es2016",\n      "es2017",\n      "es2018",\n      "dom"\n    ]\n  },\n  "include": ["./src"],\n  "exclude": [\n    "**/*.spec.ts",\n    "**/*.spec.tsx",\n    "**/*.test.ts",\n    "**/*.test.tsx"\n  ]\n}\n')),(0,r.kt)("p",null,"Add to ",(0,r.kt)("inlineCode",{parentName:"p"},"dependencies")," library ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/tslib"},"tslib"),":"),(0,r.kt)(l.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,r.kt)(i.Z,{value:"npm",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"npm install tslib\n"))),(0,r.kt)(i.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"yarn add tslib\n")))),(0,r.kt)("p",null,"Build package with command ",(0,r.kt)("inlineCode",{parentName:"p"},"tramvai-build"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-build --preserveModules --forPublish\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"with flag ",(0,r.kt)("inlineCode",{parentName:"p"},"--preserveModules")," tramvai-build wil preserve file structure of library modules for better tree-shaking")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"with flag ",(0,r.kt)("inlineCode",{parentName:"p"},"--forPublish")," tramvai-build replaces some fields in ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," in order to make built package usable in the end apps, for example ",(0,r.kt)("inlineCode",{parentName:"p"},'"browser"')," field with object value can be updated`")),(0,r.kt)("h2",{id:"explanation"},"Explanation"),(0,r.kt)("p",null,"The main purpose for the lib is the effective ",(0,r.kt)("inlineCode",{parentName:"p"},"production")," build for TypeScript package using ",(0,r.kt)("a",{parentName:"p",href:"https://rollupjs.org/"},"rollup"),", with ",(0,r.kt)("a",{parentName:"p",href:"https://rollupjs.org/guide/en/#rollupwatch"},"watch")," mode support."),(0,r.kt)("p",null,"Such builds, especially for monorepositories with big number of packages, can take a long time and are not very comfortable to work. Thats why, for the ",(0,r.kt)("inlineCode",{parentName:"p"},"development")," environment it is preferred to use ",(0,r.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org/docs/handbook/compiler-options.html"},"tsc")," with ",(0,r.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org/docs/handbook/project-references.html"},"project references")," and ",(0,r.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org/docs/handbook/release-notes/typescript-3-4.html#faster-subsequent-builds-with-the---incremental-flag"},"incremental build"),"."),(0,r.kt)("p",null,"Recommended and automatically generated ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," for ",(0,r.kt)("inlineCode",{parentName:"p"},"@tramvai/build")," allows apps to use packages that were built either with ",(0,r.kt)("inlineCode",{parentName:"p"},"tsc"),", or with ",(0,r.kt)("inlineCode",{parentName:"p"},"@tramvai/build")," without any additional steps."),(0,r.kt)("p",null,"All of the built bundles will contain ",(0,r.kt)("inlineCode",{parentName:"p"},"ES2020")," standard code, it is expected that they will be bundled to ",(0,r.kt)("inlineCode",{parentName:"p"},"ES5")," using bundler (Webpack, etc.) with configured transpilation through ",(0,r.kt)("inlineCode",{parentName:"p"},"babel")," for packages inside ",(0,r.kt)("inlineCode",{parentName:"p"},"node_modules"),", written in modern JS."),(0,r.kt)("h3",{id:"nodejs-bundle-in-commonjs-format"},"NodeJS bundle in CommonJs format"),(0,r.kt)("p",null,"NodeJS before 12 version hasn't supported ES modules or supported it only behind special flag. ",(0,r.kt)("inlineCode",{parentName:"p"},"@tramvai/build")," generates bundle in ",(0,r.kt)("inlineCode",{parentName:"p"},"ES2020")," standard in ",(0,r.kt)("inlineCode",{parentName:"p"},"CommonJS")," format automatically. Name of the result bundle is taken from field ",(0,r.kt)("inlineCode",{parentName:"p"},"main")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json"),", e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/index.js"),"."),(0,r.kt)("p",null,"When bundling package in the app using ",(0,r.kt)("inlineCode",{parentName:"p"},"webpack")," with option ",(0,r.kt)("inlineCode",{parentName:"p"},"target: 'node'")," this ",(0,r.kt)("inlineCode",{parentName:"p"},"CommonJS")," bundle probably will not be used as webpack will prefer to use ",(0,r.kt)("inlineCode",{parentName:"p"},"module")," field while resolving source code."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"It is expected that bundle from field ",(0,r.kt)("inlineCode",{parentName:"p"},'"main"')," will be resolved only by ",(0,r.kt)("inlineCode",{parentName:"p"},"NodeJS")," itself while bundlers will use bundle from field ",(0,r.kt)("inlineCode",{parentName:"p"},'"module"'))),(0,r.kt)("h3",{id:"bundle-for-bundlers-webpack-etc-in-es-modules-format"},"Bundle for bundlers (Webpack, etc.) in ES modules format"),(0,r.kt)("p",null,"Modern bundlers support ES modules and non-standard field ",(0,r.kt)("inlineCode",{parentName:"p"},'"module"')," in ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json"),". ",(0,r.kt)("inlineCode",{parentName:"p"},"@tramvai/build")," generates bundle in ",(0,r.kt)("inlineCode",{parentName:"p"},"ES2020")," standard in ",(0,r.kt)("inlineCode",{parentName:"p"},"ES modules")," format automatically. Name of the result bundle is calculates from field ",(0,r.kt)("inlineCode",{parentName:"p"},"main")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," by adding postfix ",(0,r.kt)("inlineCode",{parentName:"p"},".es")," e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/index.es.js"),"."),(0,r.kt)("p",null,"If build was called with flag ",(0,r.kt)("inlineCode",{parentName:"p"},"--forPublish")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," will be added new field ",(0,r.kt)("inlineCode",{parentName:"p"},'"module": "lib/index.es.js"'),"."),(0,r.kt)("p",null,"When bundling package in the app through ",(0,r.kt)("inlineCode",{parentName:"p"},"webpack")," with option ",(0,r.kt)("inlineCode",{parentName:"p"},"target: 'node'")," bundle from field ",(0,r.kt)("inlineCode",{parentName:"p"},"module")," will have higher priority over bundle from ",(0,r.kt)("inlineCode",{parentName:"p"},"main"),"."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("inlineCode",{parentName:"p"},"ES2020")," code standard is generated as it is expected that bundle from field ",(0,r.kt)("inlineCode",{parentName:"p"},'"module"')," will be resolved by bundler with configured transpilation through ",(0,r.kt)("inlineCode",{parentName:"p"},"babel")," for packages inside ",(0,r.kt)("inlineCode",{parentName:"p"},"node_modules"),", written in modern JS. Why we still prefer to use ",(0,r.kt)("inlineCode",{parentName:"p"},"ES5")," code over ",(0,r.kt)("inlineCode",{parentName:"p"},"ES2020"),"? Apparently, code in ",(0,r.kt)("inlineCode",{parentName:"p"},"ES5")," is still notably faster on NodeJS server. In the same time output bundle size is not important on server.")),(0,r.kt)("h3",{id:"bundle-for-browsers"},"Bundle for browsers"),(0,r.kt)("p",null,"Modern bundlers support ES modules and non-standard field ",(0,r.kt)("inlineCode",{parentName:"p"},'"browser"')," in ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json"),". When field ",(0,r.kt)("inlineCode",{parentName:"p"},"browser")," in specified in ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"@tramvai/build")," will generate bundle in ",(0,r.kt)("inlineCode",{parentName:"p"},"ES2020")," standard in ",(0,r.kt)("inlineCode",{parentName:"p"},"ES modules")," format."),(0,r.kt)("p",null,"If field ",(0,r.kt)("inlineCode",{parentName:"p"},"browser")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," is defined as a string then this string determines entry point to ",(0,r.kt)("inlineCode",{parentName:"p"},"browser")," bundle and its name. E.g. when ",(0,r.kt)("inlineCode",{parentName:"p"},'"browser": "lib/browser.js"')," entry point will be ",(0,r.kt)("inlineCode",{parentName:"p"},"src/browser.ts")," and bundle will have a name ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/browser.js"),"."),(0,r.kt)("p",null,"Otherwise, if field ",(0,r.kt)("inlineCode",{parentName:"p"},"browser")," is defined as an object and build was called with flag ",(0,r.kt)("inlineCode",{parentName:"p"},"--forPublish")," then name is defined by the field ",(0,r.kt)("inlineCode",{parentName:"p"},"main")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," with adding postfix ",(0,r.kt)("inlineCode",{parentName:"p"},".browser")," e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/index.browser.js"),". After that to field ",(0,r.kt)("inlineCode",{parentName:"p"},"browser")," new property will be added as pointer for bundlers to bundle for the browser, instead of the field ",(0,r.kt)("inlineCode",{parentName:"p"},"module"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "browser": {\n    ...,\n    "./index.es.js": "./index.browser.js"\n  }\n}\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Specification for the field ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/defunctzombie/package-browser-field-spec"},"browser"))),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("inlineCode",{parentName:"p"},"ES2020")," code standard is generated as it is expected that bundle from ",(0,r.kt)("inlineCode",{parentName:"p"},'"browser"')," field will be resolved by bundler with configured transpilation through ",(0,r.kt)("inlineCode",{parentName:"p"},"babel")," for packages inside ",(0,r.kt)("inlineCode",{parentName:"p"},"node_modules")," written in modern JS to the code according to the ",(0,r.kt)("inlineCode",{parentName:"p"},"browserslist")," config.")),(0,r.kt)("p",null,"When building our package in the app with ",(0,r.kt)("inlineCode",{parentName:"p"},"webpack")," with option ",(0,r.kt)("inlineCode",{parentName:"p"},"target: 'web'")," bundle from field ",(0,r.kt)("inlineCode",{parentName:"p"},"browser")," will be prioritized over field ",(0,r.kt)("inlineCode",{parentName:"p"},"module"),"."),(0,r.kt)("h3",{id:"copy-static-assets"},"Copy static assets"),(0,r.kt)("p",null,"For every build, all of the non JS/TS/JSON files (e.g. CSS, fonts, images) are copied to the output bundle preserving their relative paths (e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"src/css/style.css")," -> ",(0,r.kt)("inlineCode",{parentName:"p"},"lib/css/style.css"),"). You can disable such copying by using flag ",(0,r.kt)("inlineCode",{parentName:"p"},"copyStaticAssets"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-build --copyStaticAssets false\n")),(0,r.kt)("h3",{id:"build-and-copy-migrations"},"Build and copy migrations"),(0,r.kt)("p",null,"When directory ",(0,r.kt)("inlineCode",{parentName:"p"},"migrations")," has any code files they are considered as migration files. These files will be compiled to ",(0,r.kt)("inlineCode",{parentName:"p"},".js")," and copied to directory ",(0,r.kt)("inlineCode",{parentName:"p"},"__migrations__"),"."),(0,r.kt)("h2",{id:"cli"},"CLI"),(0,r.kt)("h3",{id:"single-build"},"Single build"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-build\n")),(0,r.kt)("h3",{id:"build-in-watch-mode"},"Build in watch mode"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-build --watch\n")),(0,r.kt)("h3",{id:"copy-static-assets-1"},"Copy static assets"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-copy\n")),(0,r.kt)("h3",{id:"available-flags"},"Available flags"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-build --help\n")),(0,r.kt)("h2",{id:"javascript-api"},"JavaScript API"),(0,r.kt)("h3",{id:"tramvaibuild"},"TramvaiBuild"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"TramvaiBuild")," is used to configure build process for following usage."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"import { TramvaiBuild } from '@tramvai/build';\n\nnew TramvaiBuild(options);\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Available options:")),(0,r.kt)("p",null,(0,r.kt)("pre",{parentName:"p"},(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export type Options = {\n  sourceDir: string;\n  copyStaticAssets: boolean;\n  watchMode?: boolean;\n  forPublish?: boolean;\n  preserveModules?: boolean;\n  only?: 'migrations' | 'tests';\n};\n\n"))),(0,r.kt)("h3",{id:"build"},"Build"),(0,r.kt)("p",null,"Method ",(0,r.kt)("inlineCode",{parentName:"p"},"TramvaiBuild.start")," builds package either single time or in ",(0,r.kt)("inlineCode",{parentName:"p"},"watch")," mode depending on configuration of ",(0,r.kt)("inlineCode",{parentName:"p"},"TramvaiBuild"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"import { TramvaiBuild } from '@tramvai/build';\n\nnew TramvaiBuild(options).start();\n")),(0,r.kt)("h3",{id:"copy-static-files"},"Copy static files"),(0,r.kt)("p",null,"Method ",(0,r.kt)("inlineCode",{parentName:"p"},"TramvaiBuild.copy")," copies static assets to the ",(0,r.kt)("inlineCode",{parentName:"p"},"output")," directory:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"import { TramvaiBuild } from '@tramvai/build';\n\nnew TramvaiBuild(options).copy();\n")),(0,r.kt)("h2",{id:"how-to"},"How to"),(0,r.kt)("h3",{id:"build-separate-bundle-for-browsers"},"Build separate bundle for browsers"),(0,r.kt)("p",null,"Let's say we have to entry points. One is for the server - ",(0,r.kt)("inlineCode",{parentName:"p"},"src/server.ts")," and for the client - ",(0,r.kt)("inlineCode",{parentName:"p"},"src/browser.ts"),". In this case we should set field ",(0,r.kt)("inlineCode",{parentName:"p"},"browser")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," the next way:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "main": "lib/server.js",\n  "browser": "lib/browser.js"\n}\n')),(0,r.kt)("p",null,"After build for publication we will get next ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "main": "lib/server.js",\n  "browser": "lib/browser.js",\n  "typings": "lib/server.d.ts",\n  "module": "lib/server.es.js"\n}\n')),(0,r.kt)("h3",{id:"replace-specific-module-for-browser-bundle"},"Replace specific module for browser bundle"),(0,r.kt)("p",null,"Let's say we have one entry point - ",(0,r.kt)("inlineCode",{parentName:"p"},"src/index.ts")," and a module ",(0,r.kt)("inlineCode",{parentName:"p"},"src/external.ts")," we want to replace by ",(0,r.kt)("inlineCode",{parentName:"p"},"src/external.browser.ts"),". In this case we should set field ",(0,r.kt)("inlineCode",{parentName:"p"},"browser")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," the next way:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "main": "lib/index.js",\n  "browser": {\n    "./lib/external.js": "./lib/external.browser.js"\n  }\n}\n')),(0,r.kt)("p",null,"After build for publication we will get next ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "main": "lib/index.js",\n  "browser": {\n    "./lib/external.js": "./lib/external.browser.js",\n    "./lib/index.es.js": "./lib/index.browser.js"\n  },\n  "typings": "lib/index.d.ts",\n  "module": "lib/index.es.js"\n}\n')),(0,r.kt)("h3",{id:"build-all-of-the-packages-in-monorepo-in-watch-mode"},"Build all of the packages in monorepo in watch mode"),(0,r.kt)("p",null,"@TODO + link to ",(0,r.kt)("inlineCode",{parentName:"p"},"@tinkoff/fix-ts-references")),(0,r.kt)("h3",{id:"import-module-only-under-some-circumstances-or-put-module-to-separate-chunk"},"Import module only under some circumstances or put module to separate chunk"),(0,r.kt)("p",null,"Instead of static imports you can use dynamic import or require. In this case imported module will be build in the separate chunk. Later this chunk can be added by bundler to the generated bundle and if dynamic import was used it will be separate chunk as well after bundlers build, but when using require separate chunk will not be generated."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-tsx"},"let func = noop;\n\nif (process.env.NODE_ENV !== 'production') {\n  func = require('./realFunc').func;\n}\n\nexport { func };\n")),(0,r.kt)("h3",{id:"use-json-in-package"},"Use JSON in package"),(0,r.kt)("p",null,"By default in root ",(0,r.kt)("inlineCode",{parentName:"p"},"tsconfig.json")," option ",(0,r.kt)("inlineCode",{parentName:"p"},"resolveJsonModule")," is enabled. It is allows to import json-files the same way as usual source code using ",(0,r.kt)("inlineCode",{parentName:"p"},"import"),", moreover typecheck and tree-shaking will work to json as well when publishing package. To disable ts errors for json imports add to ",(0,r.kt)("inlineCode",{parentName:"p"},"tsconfig.json")," of the package new entry to field ",(0,r.kt)("inlineCode",{parentName:"p"},"includes"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "includes": ["./src", "./src/**/*.json"]\n}\n')),(0,r.kt)("h3",{id:"use-assets-file-in-the-package-eg-css-svg"},"Use assets file in the package (e.g. css, svg)"),(0,r.kt)("p",null,"These files are not used in bundle or source code and ts will ignore them. For proper package usage additional setup should be done. Add script ",(0,r.kt)("inlineCode",{parentName:"p"},"tramvai-copy")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "scripts": {\n    "copy-static-assets": "tramvai-copy"\n  }\n}\n')),(0,r.kt)("p",null,"This script will copy not related files to source code to the output directory. Copying itself happens either on dependencies install in the repository root or on package publishing. As for some reasons output directory might be deleted it may be needed to rerun ",(0,r.kt)("inlineCode",{parentName:"p"},"tramvai-copy")," command for package."),(0,r.kt)("h3",{id:"use-css-modules"},"Use css-modules"),(0,r.kt)("p",null,"In order to disable typescript errors for css-modules imports add new file ",(0,r.kt)("inlineCode",{parentName:"p"},"typings.d.ts")," to the ",(0,r.kt)("inlineCode",{parentName:"p"},"src")," folder with the next content:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-tsx"},"declare module '*.css' {\n  const value: any;\n  export default value;\n}\n")),(0,r.kt)("p",null,"To copy css while deb-build change next command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"watch": "tramvai-copy && tsc -w"\n')),(0,r.kt)("p",null,"Such imports are not compiled. To use it properly you can use ",(0,r.kt)("inlineCode",{parentName:"p"},"@tramvai/cli")," for building app or any other solution for the css-modules."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"When building correctness of imports for the css is not checking so check your package manually before publication.")),(0,r.kt)("h3",{id:"build-only-migrations-or-tests"},"Build only migrations or tests"),(0,r.kt)("p",null,"If you need to build only migrations or tests files then you can specify option ",(0,r.kt)("inlineCode",{parentName:"p"},"--only")," with either ",(0,r.kt)("inlineCode",{parentName:"p"},"migrations")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"tests")," value."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-build --only migrations\ntramvai-build --only tests\n")))}m.isMDXComponent=!0}}]);