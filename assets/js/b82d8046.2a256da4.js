"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[8080],{3905:function(e,t,n){n.d(t,{Zo:function(){return g},kt:function(){return u}});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=o.createContext({}),p=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},g=function(e){var t=p(e.components);return o.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},c=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,g=i(e,["components","mdxType","originalType","parentName"]),c=p(n),u=r,m=c["".concat(s,".").concat(u)]||c[u]||d[u]||a;return n?o.createElement(m,l(l({ref:t},g),{},{components:n})):o.createElement(m,l({ref:t},g))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,l=new Array(a);l[0]=c;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:r,l[1]=i;for(var p=2;p<a;p++)l[p]=n[p];return o.createElement.apply(null,l)}return o.createElement.apply(null,n)}c.displayName="MDXCreateElement"},8399:function(e,t,n){n.r(t),n.d(t,{assets:function(){return s},contentTitle:function(){return l},default:function(){return d},frontMatter:function(){return a},metadata:function(){return i},toc:function(){return p}});var o=n(7462),r=(n(7294),n(3905));const a={id:"logging",title:"Logging"},l=void 0,i={unversionedId:"features/logging",id:"features/logging",title:"Logging",description:"Explanation",source:"@site/tmp-docs/03-features/014-logging.md",sourceDirName:"03-features",slug:"/features/logging",permalink:"/docs/features/logging",draft:!1,editUrl:"https://github.com/tramvaijs/tramvai/-/edit/master/docs/tmp-docs/03-features/014-logging.md",tags:[],version:"current",sidebarPosition:14,frontMatter:{id:"logging",title:"Logging"},sidebar:"sidebar",previous:{title:"SEO and Meta",permalink:"/docs/features/seo"},next:{title:"Overview",permalink:"/docs/features/child-app/overview"}},s={},p=[{value:"Explanation",id:"explanation",level:2},{value:"Logger",id:"logger",level:3},{value:"Main concepts",id:"main-concepts",level:3},{value:"Available reporters",id:"available-reporters",level:3},{value:"Usage",id:"usage",level:2},{value:"Installation",id:"installation",level:3},{value:"Configuration",id:"configuration",level:3},{value:"Root logger",id:"root-logger",level:4},{value:"Child logger",id:"child-logger",level:4},{value:"Logging",id:"logging",level:3},{value:"Display logs",id:"display-logs",level:3},{value:"Server logs",id:"server-logs",level:4},{value:"Change server logs settings in runtime",id:"change-server-logs-settings-in-runtime",level:5},{value:"Client logs",id:"client-logs",level:4},{value:"Change browser logs settings in runtime",id:"change-browser-logs-settings-in-runtime",level:5},{value:"How to",id:"how-to",level:2},{value:"How to see logs from the server in browser",id:"how-to-see-logs-from-the-server-in-browser",level:3},{value:"How to see logs for the HTTP requests",id:"how-to-see-logs-for-the-http-requests",level:3},{value:"How to send logs to the API",id:"how-to-send-logs-to-the-api",level:3},{value:"How to override emit level for remote logs?",id:"how-to-override-emit-level-for-remote-logs",level:3},{value:"How to extend logs by user-specific data?",id:"how-to-extend-logs-by-user-specific-data",level:3},{value:"How to properly format logs?",id:"how-to-properly-format-logs",level:3}],g={toc:p};function d(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,o.Z)({},g,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"explanation"},"Explanation"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"tramvai")," uses our internal powerful and flexible ",(0,r.kt)("a",{parentName:"p",href:"/docs/references/libs/logger"},"@tinkoff/logger")," library for universal logging both on server and client side."),(0,r.kt)("p",null,"Token ",(0,r.kt)("inlineCode",{parentName:"p"},"LOGGER_TOKEN")," provides a ",(0,r.kt)("a",{parentName:"p",href:"#logger"},"logger factory")," with shared across all application basic configuration."),(0,r.kt)("h3",{id:"logger"},"Logger"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"LOGGER_TOKEN")," it is both a factory and a logger at the same time, but we recommend using it ",(0,r.kt)("strong",{parentName:"p"},"only")," as a factory, which will return ",(0,r.kt)("a",{parentName:"p",href:"/docs/references/libs/logger#child-loggers"},"child loggers"),", because name passed to the factory will be added to the log object in ",(0,r.kt)("inlineCode",{parentName:"p"},"name")," field. This key is used when you want to ",(0,r.kt)("a",{parentName:"p",href:"#display-logs"},"show only necessary logs"),"."),(0,r.kt)("h3",{id:"main-concepts"},"Main concepts"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docs/references/libs/logger#child-loggers"},"Child loggers")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docs/references/libs/logger#filter"},"Logs filters")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docs/references/libs/logger#extension"},"Logs extensions")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docs/references/libs/logger#reporter"},"Reporters"))),(0,r.kt)("h3",{id:"available-reporters"},"Available reporters"),(0,r.kt)("p",null,"You can find all predefined reporters in ",(0,r.kt)("a",{parentName:"p",href:"/docs/references/libs/logger#bundled-reporters"},"@tinkoff/logger")," library documentation"),(0,r.kt)("h2",{id:"usage"},"Usage"),(0,r.kt)("h3",{id:"installation"},"Installation"),(0,r.kt)("p",null,"The module is automatically installed and added with the @tramvai/module-common module."),(0,r.kt)("h3",{id:"configuration"},"Configuration"),(0,r.kt)("h4",{id:"root-logger"},"Root logger"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"LOGGER_INIT_HOOK")," token is used to configure root logger (",(0,r.kt)("inlineCode",{parentName:"p"},"LOGGER_TOKEN"),") when it is created."),(0,r.kt)("p",null,"For example you want to add custom ",(0,r.kt)("a",{parentName:"p",href:"/docs/references/libs/logger#extension"},"extension"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"import { provide, Scope } from '@tramvai/core';\nimport { LOGGER_INIT_HOOK } from '@tramvai/tokens-common';\n\nconst provider = provide({\n  provide: LOGGER_INIT_HOOK,\n  scope: Scope.SINGLETON,\n  useValue: (loggerInstance) => {\n    loggerInstance.addExtension({\n      extend(logObj: LogObj): LogObj {\n        return {\n          ...logObj,\n          customField: 'customValue',\n        };\n      },\n    });\n  },\n});\n")),(0,r.kt)("p",null,"This extension will be applied to all child loggers, created from ",(0,r.kt)("inlineCode",{parentName:"p"},"LOGGER_TOKEN")," factory."),(0,r.kt)("h4",{id:"child-logger"},"Child logger"),(0,r.kt)("p",null,"You can find child logger configuration example in ",(0,r.kt)("a",{parentName:"p",href:"/docs/references/libs/logger#local-logger-configuration"},"@tinkoff/logger")," library documentation"),(0,r.kt)("h3",{id:"logging"},"Logging"),(0,r.kt)("p",null,"You can get ",(0,r.kt)("inlineCode",{parentName:"p"},"LOGGER_TOKEN")," from DI in components, actions and any other providers, for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"import { declareAction } from '@tramvai/core';\n\nconst action = declareAction({\n  name: 'myAction',\n  async fn() {\n    // create child logger with name 'my-action'\n    const log = this.deps.logger('my-action');\n\n    try {\n      await doAsyncStuff();\n\n      // { name: 'my-action', type: 'info', message: 'Action completed!', level, date }\n      log.info('Action completed!');\n    } catch (error) {\n      // { name: 'my-action', type: 'error', event: 'failed', message: 'Action failed!', reason: Error, level, date }\n      log.info({\n        event: 'failed',\n        message: 'Action failed!',\n        reason: error,\n      });\n    }\n  },\n  deps: {\n    logger: LOGGER_TOKEN,\n  },\n});\n")),(0,r.kt)("h3",{id:"display-logs"},"Display logs"),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"By default, on server all of the logs of level ",(0,r.kt)("strong",{parentName:"p"},"warn")," and above are enabled."),(0,r.kt)("p",{parentName:"admonition"},"On the client in dev-mode all the logs of level ",(0,r.kt)("strong",{parentName:"p"},"error")," and above are enabled while in prod-mode all of the logs on client are disabled.")),(0,r.kt)("p",null,"Complete information about displaying logs can be found in ",(0,r.kt)("a",{parentName:"p",href:"/docs/references/libs/logger#display-logs"},"@tinkoff/logger")," library documentation."),(0,r.kt)("h4",{id:"server-logs"},"Server logs"),(0,r.kt)("p",null,"On server side logs behavior is controlled by envs ",(0,r.kt)("inlineCode",{parentName:"p"},"LOG_ENABLE")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"LOG_LEVEL"),", e.g.:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"LOG_LEVEL=info\nLOG_ENABLE=route*\n")),(0,r.kt)("h5",{id:"change-server-logs-settings-in-runtime"},"Change server logs settings in runtime"),(0,r.kt)("p",null,"You can change this settings in runtime using papi-route ",(0,r.kt)("inlineCode",{parentName:"p"},"{app}/private/papi/logger")),(0,r.kt)("p",null,"Displaying of the logs is changed by query with the name ",(0,r.kt)("inlineCode",{parentName:"p"},"enable"),", e.g.:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"https://localhost:3000/{app}/private/papi/logger?enable=request.tinkoff\n")),(0,r.kt)("p",null,"Level of the logs is change by query with the name ",(0,r.kt)("inlineCode",{parentName:"p"},"level"),", e.g.:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"https://localhost:3000/{app}/private/papi/logger?level=warn\n")),(0,r.kt)("p",null,"To reset settings to default, based on env, use ",(0,r.kt)("inlineCode",{parentName:"p"},"mode=default"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"https://localhost:3000/{app}/private/papi/logger?mode=default\n")),(0,r.kt)("h4",{id:"client-logs"},"Client logs"),(0,r.kt)("p",null,"On client side logs behavior can be changed by using ",(0,r.kt)("inlineCode",{parentName:"p"},"LOGGER_TOKEN")," with the following methods - ",(0,r.kt)("inlineCode",{parentName:"p"},"logger.enable()")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"logger.setLevel()")),(0,r.kt)("h5",{id:"change-browser-logs-settings-in-runtime"},"Change browser logs settings in runtime"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"LOGGER_TOKEN")," will be available in global variable - ",(0,r.kt)("inlineCode",{parentName:"p"},"window.logger"),", so you can run the following code in browser console:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"logger.setLevel('info');\nlogger.enable('route*');\n")),(0,r.kt)("h2",{id:"how-to"},"How to"),(0,r.kt)("h3",{id:"how-to-see-logs-from-the-server-in-browser"},"How to see logs from the server in browser"),(0,r.kt)("p",null,"This functionality is available only in dev-mode and can make development a little easier."),(0,r.kt)("p",null,"In browser console when loading page of the app the special log group with name ",(0,r.kt)("inlineCode",{parentName:"p"},"Tramvai SSR Logs")," will be showed. If you open this group you will see logs from the server that was logged to this particular request. Herewith will be displayed only logs that are enabled for the ",(0,r.kt)("a",{parentName:"p",href:"#display-logs"},"displaying on the server"),"."),(0,r.kt)("h3",{id:"how-to-see-logs-for-the-http-requests"},"How to see logs for the HTTP requests"),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Works only with ",(0,r.kt)("a",{parentName:"p",href:"https://tinkoff.github.io/tinkoff-request/"},"@tinkoff/request"))),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"/docs/references/modules/http-client"},"http-client")," is already passes logger and its settings to the ",(0,r.kt)("a",{parentName:"p",href:"https://tinkoff.github.io/tinkoff-request/docs/plugins/log.html"},"log plugin"),"."),(0,r.kt)("p",null,"Plugin automatically generates names for loggers using template ",(0,r.kt)("inlineCode",{parentName:"p"},"request.${name}")," that might be used to setting up ",(0,r.kt)("a",{parentName:"p",href:"#display-logs"},"displaying of logs"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"const provider = provide({\n  provide: MY_HTTP_CLIENT,\n  useFactory: ({ factory, envManager }) => {\n    return factory({\n      name: 'my-api-name',\n      baseUrl: envManager.get('MY_API_URL'),\n    });\n  },\n  deps: {\n    factory: HTTP_CLIENT_FACTORY,\n    envManager: ENV_MANAGER_TOKEN,\n  },\n});\n")),(0,r.kt)("p",null,"As name of the logger equals to ",(0,r.kt)("inlineCode",{parentName:"p"},"my-api-name")," to show logs:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"on server extend env ",(0,r.kt)("inlineCode",{parentName:"li"},"LOG_ENABLE: 'request.my-api-name'")),(0,r.kt)("li",{parentName:"ul"},"on client call ",(0,r.kt)("inlineCode",{parentName:"li"},"logger.enable('request.my-api-name')"))),(0,r.kt)("h3",{id:"how-to-send-logs-to-the-api"},"How to send logs to the API"),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"It is implied that logs from the server are collected by the external tool that has access to the server console output and because of this logging to the external API from the server is not needed.")),(0,r.kt)("p",null,"For browser logs, you can send them to the API with ",(0,r.kt)("a",{parentName:"p",href:"/docs/references/libs/logger#remotereporter"},"RemoteReporter"),"."),(0,r.kt)("p",null,"For example, if we want to send logs with levels ",(0,r.kt)("inlineCode",{parentName:"p"},"error")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"fatal")," to url declared in environment variable ",(0,r.kt)("inlineCode",{parentName:"p"},"FRONT_LOG_API"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"import { createToken, provide, Scope, APP_INFO_TOKEN } from '@tramvai/core';\nimport {\n  ENV_USED_TOKEN,\n  ENV_MANAGER_TOKEN,\n  LOGGER_INIT_HOOK,\n  LOGGER_REMOTE_REPORTER,\n} from '@tramvai/tokens-common';\nimport { RemoteReporter } from '@tinkoff/logger';\nimport { isUrl } from '@tinkoff/env-validators';\n\nconst providers = [\n  // provide new env variable with logs collector endpoint\n  provide({\n    provide: ENV_USED_TOKEN,\n    useValue: [\n      // use isUrl for validation\n      { key: 'FRONT_LOG_API', dehydrate: true, validator: isUrl },\n    ],\n  }),\n  // provide new remote reporter\n  provide({\n    provide: LOGGER_REMOTE_REPORTER,\n    // we need only one instance of reporter\n    scope: Scope.SINGLETON,\n    useFactory: ({ appInfo, envManager, wuid }) => {\n      const { appName } = appInfo;\n      const logApi = envManager.get('FRONT_LOG_API');\n\n      return new RemoteReporter({\n        // number of parallel request\n        requestCount: 1,\n        // log levels which will be send to api\n        emitLevels: { error: true, fatal: true },\n        makeRequest(logObj) {\n          return sendLog({\n            logApi,\n            // additional information for every reported logs\n            payload: {\n              ...logObj,\n              appName,\n              userAgent: window.navigator.userAgent,\n              href: window.location.href,\n            },\n          });\n        },\n      });\n    },\n    deps: {\n      appInfo: APP_INFO_TOKEN,\n      envManager: ENV_MANAGER_TOKEN,\n    },\n  }),\n];\n")),(0,r.kt)("h3",{id:"how-to-override-emit-level-for-remote-logs"},"How to override emit level for remote logs?"),(0,r.kt)("p",null,"When you are using ",(0,r.kt)("inlineCode",{parentName:"p"},"LOGGER_REMOTE_REPORTER"),", all logs with default ",(0,r.kt)("inlineCode",{parentName:"p"},"remote")," property always will be passed to remote reporter (meantime any other logs will be filtered by current emit level configured with ",(0,r.kt)("inlineCode",{parentName:"p"},"logger.setLevel")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"LOG_LEVEL")," variables):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"// remote has priority over RemoteReporter emitLevels\nconst log1 = logger({ name: 'test', defaults: { remote: true } });\n\n// remote.emitLevels has priority over RemoteReporter emitLevels\nconst log2 = logger({ name: 'test', defaults: { remote: { emitLevels: { info: true } } } });\n\n// send to API\nlog1.info('first');\nlog2.info('second');\n\n// not sended to API\nlog2.trace('second');\n")),(0,r.kt)("h3",{id:"how-to-extend-logs-by-user-specific-data"},"How to extend logs by user-specific data?"),(0,r.kt)("p",null,"For example, you want to add ",(0,r.kt)("inlineCode",{parentName:"p"},"User-Agent")," to all logs for concrete user."),(0,r.kt)("p",null,"Logger extensions registered in ",(0,r.kt)("inlineCode",{parentName:"p"},"LOGGER_INIT_HOOK")," provider is not suitable for this case, because registration finishes early, at singletone scope, because of that request-specific providers are not available for this token at server-side."),(0,r.kt)("p",null,"It is not a problem for client code, but mostly we want to have one consistent way of extending logs."),(0,r.kt)("p",null,"For that, token ",(0,r.kt)("inlineCode",{parentName:"p"},"LOGGER_SHARED_CONTEXT")," was created. At server-side, ",(0,r.kt)("a",{parentName:"p",href:"https://nodejs.org/api/async_hooks.html#class-asynclocalstorage"},"AsyncLocalStorage")," is used, and a simple ",(0,r.kt)("inlineCode",{parentName:"p"},"Map")," object at client-side."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"import { commandLineListTokens, provide } from '@tramvai/core';\nimport { LOGGER_SHARED_CONTEXT } from '@tramvai/tokens-common';\n\nconst provider = provide({\n  // first stage at server-side, where `asyncLocalStorage` context is available\n  provide: commandLineListTokens.customerStart,\n  useFactory: ({ loggerSharedContext, requestManager }) => {\n    return function updateLoggerContext() {\n      // depend of environment read UserAgent from request object or window.navigator\n      const userAgent = typeof window === 'undefined'\n        ? requestManager.getHeader('user-agent')\n        : window.navigator.userAgent;\n\n      // `userAgent` property will be added to all logs, sended after `customerStart` stage\n      loggerSharedContext.set('userAgent', userAgent);\n    };\n  },\n  deps: {\n    loggerSharedContext: LOGGER_SHARED_CONTEXT,\n    requestManager: REQUEST_MANAGER_TOKEN, \n  },\n});\n")),(0,r.kt)("h3",{id:"how-to-properly-format-logs"},"How to properly format logs?"),(0,r.kt)("p",null,"See ",(0,r.kt)("a",{parentName:"p",href:"/docs/references/libs/logger#how-to-log-properly"},"@tinkoff/logger")," library documentation"))}d.isMDXComponent=!0}}]);