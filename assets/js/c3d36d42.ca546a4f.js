"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[2294],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>d});var i=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=i.createContext({}),p=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},m=function(e){var t=p(e.components);return i.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},u=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),u=p(n),d=a,h=u["".concat(s,".").concat(d)]||u[d]||c[d]||r;return n?i.createElement(h,o(o({ref:t},m),{},{components:n})):i.createElement(h,o({ref:t},m))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var p=2;p<r;p++)o[p]=n[p];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}u.displayName="MDXCreateElement"},6271:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>c,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var i=n(7462),a=(n(7294),n(3905));const r={id:"server-optimization",title:"Server optimization"},o=void 0,l={unversionedId:"guides/server-optimization",id:"guides/server-optimization",title:"Server optimization",description:"Introduction",source:"@site/tmp-docs/guides/server-optimization.md",sourceDirName:"guides",slug:"/guides/server-optimization",permalink:"/docs/guides/server-optimization",draft:!1,editUrl:"https://github.com/tramvaijs/tramvai/-/edit/master/docs/tmp-docs/guides/server-optimization.md",tags:[],version:"current",frontMatter:{id:"server-optimization",title:"Server optimization"},sidebar:"sidebar",previous:{title:"React Compiler",permalink:"/docs/guides/react-compiler"},next:{title:"Storybook integration",permalink:"/docs/guides/storybook"}},s={},p=[{value:"Introduction",id:"introduction",level:2},{value:"Optimizations",id:"optimizations",level:2},{value:"K8s limits",id:"k8s-limits",level:3},{value:"Request Limiter",id:"request-limiter",level:3},{value:"Semi space size",id:"semi-space-size",level:3},{value:"<code>libuv</code> threads",id:"libuv-threads",level:3},{value:"DNS resolve cache",id:"dns-resolve-cache",level:3},{value:"Metrics",id:"metrics",level:2},{value:"Profiling",id:"profiling",level:2},{value:"CPU profiling",id:"cpu-profiling",level:3},{value:"Memory profiling",id:"memory-profiling",level:3}],m={toc:p};function c({components:e,...t}){return(0,a.kt)("wrapper",(0,i.Z)({},m,t,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"introduction"},"Introduction"),(0,a.kt)("p",null,"In most server applications there is a set of resources that can be optimized:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"CPU"),(0,a.kt)("li",{parentName:"ul"},"Memory"),(0,a.kt)("li",{parentName:"ul"},"Network")),(0,a.kt)("p",null,"And there are a common set of metrics that can be used to measure application performance:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Latency"),(0,a.kt)("li",{parentName:"ul"},"Throughput")),(0,a.kt)("p",null,"Node.js with Server-Side Rendering have some specifics:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Node.js is single-threaded and doesn't like long blocking tasks"),(0,a.kt)("li",{parentName:"ul"},"SSR unfortunately is long blocking task")),(0,a.kt)("p",null,"SSR especially suffer for CPU limits in Kubernetes clusters - ",(0,a.kt)("a",{parentName:"p",href:"https://medium.com/pipedrive-engineering/how-we-choked-our-kubernetes-nodejs-services-932acc8cc2be"},"https://medium.com/pipedrive-engineering/how-we-choked-our-kubernetes-nodejs-services-932acc8cc2be")),(0,a.kt)("p",null,"This guide will contain a set of recommended optimizations to make your application faster and more reliable in all self-hosted environments:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#k8s-limits"},"K8s limits")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#request-limiter"},"Request Limiter")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#semi-space-size"},"Semi space size")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#agent-keepalive"},"Agent keepAlive")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#libuv-threads"},(0,a.kt)("inlineCode",{parentName:"a"},"libuv")," threads")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#dns-resolve-cache"},"DNS resolve cache"))),(0,a.kt)("h2",{id:"optimizations"},"Optimizations"),(0,a.kt)("h3",{id:"k8s-limits"},"K8s limits"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": provide ",(0,a.kt)("strong",{parentName:"p"},"1000m - 1150m")," CPU limit/request, run Node.js with ",(0,a.kt)("inlineCode",{parentName:"p"},"--max-old-space-size=(0.75% * memory.limit)")," parameter"),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Starting from Node.js 24 you can use ",(0,a.kt)("inlineCode",{parentName:"p"},"--max-old-space-size-percentage=75"),".")),(0,a.kt)("p",null,"Low CPU limits can significantly slow down your application response time because of CPU throttling. More information why:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://medium.com/pipedrive-engineering/how-we-choked-our-kubernetes-nodejs-services-932acc8cc2be"},"https://medium.com/pipedrive-engineering/how-we-choked-our-kubernetes-nodejs-services-932acc8cc2be")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://web.archive.org/web/20220317223152/https://amixr.io/blog/what-wed-do-to-save-from-the-well-known-k8s-incident/"},"https://web.archive.org/web/20220317223152/https://amixr.io/blog/what-wed-do-to-save-from-the-well-known-k8s-incident/"))),(0,a.kt)("p",null,"Node.js is single-threaded, but can use multiple threads for Garbage Collector or DNS resolve. Because of that, optimal configuration is ",(0,a.kt)("strong",{parentName:"p"},"1150m")," CPU limit/request. Minimal recommended configuration is ",(0,a.kt)("strong",{parentName:"p"},"1000m")," CPU limit/request."),(0,a.kt)("p",null,"There is a one disadvantage - with this CPU limits, if you maintain a sufficient number of instances with good latency and throughput, you may experience poor CPU utilization. Nevertheless, this represents a trade-off between effective CPU usage and low latency."),(0,a.kt)("p",null,"With memory limits, to optimize memory optimization and prevent OOM failures, you need to pass ",(0,a.kt)("a",{parentName:"p",href:"https://nodejs.org/api/cli.html#--max-old-space-sizesize-in-mib"},"--max-old-space-size")," parameter to Node.js options."),(0,a.kt)("p",null,"As a start, you can calculate size by the following formula: ",(0,a.kt)("inlineCode",{parentName:"p"},"0.75 * memory.limit"),", or 75% of current container memory limit. Then you can run benchmark and monitor application metrics for a long time, and try to find optimal value. This is recommendation from ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/goldbergyoni/nodebestpractices/blob/master/sections/docker/memory-limit.md"},"Node.js Best Practices")," guide."),(0,a.kt)("p",null,"For setting this parameter you need to run ",(0,a.kt)("inlineCode",{parentName:"p"},"server.js")," using the ",(0,a.kt)("inlineCode",{parentName:"p"},"node")," command with the ",(0,a.kt)("inlineCode",{parentName:"p"},"--max-old-space-size")," parameter. This command is typically located in the ",(0,a.kt)("inlineCode",{parentName:"p"},"Dockerfile"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Dockerfile",metastring:'title="Dockerfile"',title:'"Dockerfile"'},'FROM node:20-buster-slim\nWORKDIR /app\nCOPY dist/server /app/\nCOPY package.json /app/\nENV NODE_ENV=\'production\'\n\nEXPOSE 3000\n// highlight-next-line\nCMD [ "node", "--max-old-space-size=350", "/app/server.js" ]\n')),(0,a.kt)("p",null,"Also, you can refer to k8s container resources when defining env variables:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title="Deployment manifest"',title:'"Deployment','manifest"':!0},"apiVersion: apps/v1\nkind: Deployment\nspec:\n  selector:\n    matchLabels:\n      app: app\n  template:\n    spec:\n      containers:\n        - name: app\n          env:\n            - name: MEMORY_LIMIT_BYTES\n              valueFrom:\n                resourceFieldRef:\n                  # or requests.memory\n                  resource: limits.memory\n")),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"If you are deploying to environment with VPA, you should reference to ",(0,a.kt)("inlineCode",{parentName:"p"},"requests.memory")," instead of ",(0,a.kt)("inlineCode",{parentName:"p"},"limits.memory"),".")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Dockerfile",metastring:'title="Dockerfile"',title:'"Dockerfile"'},'// highlight-next-line\nCMD [ "node" , "--max-old-space-size=$((MEMORY_LIMIT_BYTES * 75 / 100))", "main.js" ]\n')),(0,a.kt)("p",null,"Worth noting that if your runtime image does not have shell (bash, sh) you should write custom wrapper in appropriate language (e.g. Node.js) to perform computations:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const { spawn } = require('node:child_process');\nconst process = require('node:process');\n\nconst getMemoryLimit = () => {\n  const DEFAULT_SIZE = 512;\n  const FRACTION = 0.75;\n\n  const parsed = Number.parseInt(process.env.MEMORY_LIMIT_BYTES, 10);\n\n  return Math.round((parsed > 0 ? parsed / 1024 / 1024 : DEFAULT_SIZE) * FRACTION);\n};\n\nconst server = spawn(\n  'node',\n  [`--max-old-space-size=${getMemoryLimit()}`, './main.js'],\n  // Pay attention to properly link stdio of parent and child process\n  { stdio: 'inherit' }\n);\n\nserver.on('error', (error) => {\n  process.exit(1);\n});\n\nserver.on('exit', (code, signal) => {\n  process.exit(code);\n});\n")),(0,a.kt)("h3",{id:"request-limiter"},"Request Limiter"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": connect ",(0,a.kt)("inlineCode",{parentName:"p"},"@tramvai/module-request-limiter")," to your application"),(0,a.kt)("p",null,"Unexpected traffic spikes can make your application unresponsive. A blocked event loop will prevent your application from processing new and current requests, while memory usage may increase and lead to Out-of-Memory (OOM) errors."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"@tramvai/module-request-limiter")," module can monitor your application's health and dynamically limit the number of requests handled concurrently by the application. It will automatically start working once connected to the application."),(0,a.kt)("p",null,"When the application is overloaded, the module will return a ",(0,a.kt)("strong",{parentName:"p"},"429")," error to the client. You can handle this error at the load balancer level and return ",(0,a.kt)("a",{parentName:"p",href:"/docs/features/rendering/csr#csr-fallback"},"Client-Side Rendering fallback")," or some page fallback cache."),(0,a.kt)("p",null,"More information:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"/docs/references/modules/request-limiter"},(0,a.kt)("inlineCode",{parentName:"a"},"@tramvai/module-request-limiter")," documentation")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://medium.com/its-tinkoff/ssr-applications-at-scale-d57892719024"},'Article "How to scale SSR applications"'))),(0,a.kt)("h3",{id:"semi-space-size"},"Semi space size"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": set Node.js ",(0,a.kt)("inlineCode",{parentName:"p"},"--max-semi-space-size")," parameter to ",(0,a.kt)("strong",{parentName:"p"},"32mb")," or ",(0,a.kt)("strong",{parentName:"p"},"64mb"),", run benchmarks, and choose the best balance for CPU usage and memory consumption."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://nodejs.org/api/cli.html#--max-semi-space-sizesize-in-mib"},"--max-semi-space-size documentation")),(0,a.kt)("p",null,"The default value depends on the memory limit. For example, on 64-bit systems with a memory limit of 512 MiB, the max size of a semi-space defaults to 1 MiB. On 64-bit systems with a memory limit of 2 GiB, the max size of a semi-space defaults to 16 MiB."),(0,a.kt)("p",null,"During application performance profiling, you may observe that your code spends a significant amount of time on Garbage Collector (GC) work. By default, GC work too frequently, and we can reduce the number of GC runs by increasing the size of the semi space. This optimization will reduce the CPU workload and make your event loop less busy, resulting in faster response times, especially in the 95th and 99th percentiles."),(0,a.kt)("p",null,"One disadvantage of this optimization is that it will increases the memory usage of your application. ",(0,a.kt)("strong",{parentName:"p"},"For environments, where memory is limited, for example test deployments, prefer not to use this optimization"),"."),(0,a.kt)("p",null,"A good balance between performance and memory usage is achieved with a semi space size of ",(0,a.kt)("strong",{parentName:"p"},"64mb"),". It is possible to use event bigger value for this parameter, but it may not provide a significant improvement in performance and will highly increase the memory usage of your application. It is recommended to test this parameter in your specific application."),(0,a.kt)("p",null,"For setting this parameter you need to run ",(0,a.kt)("inlineCode",{parentName:"p"},"server.js")," using the ",(0,a.kt)("inlineCode",{parentName:"p"},"node")," command with the ",(0,a.kt)("inlineCode",{parentName:"p"},"--max-semi-space-size")," parameter. This command is typically located in the ",(0,a.kt)("inlineCode",{parentName:"p"},"Dockerfile"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Dockerfile",metastring:'title="Dockerfile"',title:'"Dockerfile"'},'FROM node:20-buster-slim\nWORKDIR /app\nCOPY dist/server /app/\nCOPY package.json /app/\nENV NODE_ENV=\'production\'\n\nEXPOSE 3000\n// highlight-next-line\nCMD [ "node", "--max-semi-space-size=64", "/app/server.js" ]\n')),(0,a.kt)("p",null,"More information:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.alibabacloud.com/blog/better-node-application-performance-through-gc-optimization_595119"},"https://www.alibabacloud.com/blog/better-node-application-performance-through-gc-optimization_595119")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://blog.ztec.fr/en/2024/post/node.js-20-upgrade-journey-though-unexpected-heap-issues-with-kubernetes/"},"https://blog.ztec.fr/en/2024/post/node.js-20-upgrade-journey-though-unexpected-heap-issues-with-kubernetes/")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/nodejs/node/issues/42511"},"https://github.com/nodejs/node/issues/42511"))),(0,a.kt)("h3",{id:"libuv-threads"},(0,a.kt)("inlineCode",{parentName:"h3"},"libuv")," threads"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": set env variable ",(0,a.kt)("inlineCode",{parentName:"p"},"UV_THREADPOOL_SIZE")," to ",(0,a.kt)("strong",{parentName:"p"},"8")),(0,a.kt)("p",null,"One of possible Node.js bottlenecks is APIs that use ",(0,a.kt)("inlineCode",{parentName:"p"},"libuv")," thread pool, one of them is DNS resolve. By default, ",(0,a.kt)("inlineCode",{parentName:"p"},"libuv")," thread pool size is ",(0,a.kt)("strong",{parentName:"p"},"4"),", and it can be not enough for heavy loaded application - requests from application will be queued, incoming requests also will be queued, memory usage will be increased, and at result response time will be increased or application can run out of memory."),(0,a.kt)("p",null,"From our experience, optimal ",(0,a.kt)("inlineCode",{parentName:"p"},"libuv")," thread pool size is ",(0,a.kt)("strong",{parentName:"p"},"8"),", but it can be different for your application."),(0,a.kt)("p",null,"You can increase ",(0,a.kt)("inlineCode",{parentName:"p"},"libuv")," thread pool size by setting ",(0,a.kt)("inlineCode",{parentName:"p"},"UV_THREADPOOL_SIZE")," env variable:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"UV_THREADPOOL_SIZE=8\n")),(0,a.kt)("p",null,"More information:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://nodejs.org/docs/latest-v18.x/api/cli.html#uv_threadpool_sizesize"},"about UV_THREADPOOL_SIZE")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://docs.libuv.org/en/latest/threadpool.html"},"about ",(0,a.kt)("inlineCode",{parentName:"a"},"libuv")," thread pool"))),(0,a.kt)("h3",{id:"dns-resolve-cache"},"DNS resolve cache"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"TL;DR"),": connect ",(0,a.kt)("inlineCode",{parentName:"p"},"@tramvai/module-dns-cache")," to your application"),(0,a.kt)("p",null,"DNS resolve can block application event loop and require a free threads from ",(0,a.kt)("inlineCode",{parentName:"p"},"libuv")," thread pool, and DNS lookup cache can help solve this problems and speed up your server-side HTTP requests to external API's."),(0,a.kt)("p",null,"Possible disadvantages of DNS lookup cache - it can lead to lookup errors if DNS record was changed, so long caches TTL is not recommended."),(0,a.kt)("p",null,"Also, DNS lookup cache optimization effect can be not so significant, if ",(0,a.kt)("inlineCode",{parentName:"p"},"keepAlive")," connections are used, because number of DNS resolves will be reduced."),(0,a.kt)("p",null,"More information:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"/docs/references/modules/dns-cache"},(0,a.kt)("inlineCode",{parentName:"a"},"@tramvai/module-dns-cache")," documentation")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/szmarczak/cacheable-lookup"},(0,a.kt)("inlineCode",{parentName:"a"},"cacheable-lookup")," documentation")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://httptoolkit.com/blog/configuring-nodejs-dns/"},"about DNS resolving"))),(0,a.kt)("h2",{id:"metrics"},"Metrics"),(0,a.kt)("p",null,"One of the important metrics to show how your Node.js application is busy is ",(0,a.kt)("a",{parentName:"p",href:"https://davidhettler.net/blog/event-loop-lag/"},"Event Loop Lag"),". Tramvai measure event loop lag by ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/siimon/prom-client"},"prom-client"),", and make an additional measurement with ",(0,a.kt)("inlineCode",{parentName:"p"},"setTimeout"),"."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"/docs/references/modules/metrics#metrics-list"},"Full metrics list available in Metrics module documentation")),(0,a.kt)("h2",{id:"profiling"},"Profiling"),(0,a.kt)("p",null,"Best way to optimize application CPU or memory usage is to profile it with Chrome Devtools or ",(0,a.kt)("a",{parentName:"p",href:"https://clinicjs.org/"},"Clinic.js")),(0,a.kt)("h3",{id:"cpu-profiling"},"CPU profiling"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"/docs/guides/cpu-profiling"},"Complete guide to tramvai apps CPU profiling")),(0,a.kt)("h3",{id:"memory-profiling"},"Memory profiling"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"/docs/mistakes/memory-leak"},"Complete guide to tramvai apps memory leak debugging")))}c.isMDXComponent=!0}}]);