"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[1011],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>m});var a=t(7294);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,l=function(e,n){if(null==e)return{};var t,a,l={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(l[t]=e[t]);return l}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var p=a.createContext({}),s=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},d=function(e){var n=s(e.components);return a.createElement(p.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},c=a.forwardRef((function(e,n){var t=e.components,l=e.mdxType,o=e.originalType,p=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),c=s(t),m=l,k=c["".concat(p,".").concat(m)]||c[m]||u[m]||o;return t?a.createElement(k,r(r({ref:n},d),{},{components:t})):a.createElement(k,r({ref:n},d))}));function m(e,n){var t=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var o=t.length,r=new Array(o);r[0]=c;var i={};for(var p in n)hasOwnProperty.call(n,p)&&(i[p]=n[p]);i.originalType=e,i.mdxType="string"==typeof e?e:l,r[1]=i;for(var s=2;s<o;s++)r[s]=t[s];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},1526:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>s});var a=t(7462),l=(t(7294),t(3905));const o={},r=void 0,i={unversionedId:"features/child-app/monitoring",id:"features/child-app/monitoring",title:"monitoring",description:"Child App Lifecycle Plugins",source:"@site/tmp-docs/03-features/016-child-app/021-monitoring.md",sourceDirName:"03-features/016-child-app",slug:"/features/child-app/monitoring",permalink:"/docs/features/child-app/monitoring",draft:!1,editUrl:"https://github.com/tramvaijs/tramvai/-/edit/master/docs/tmp-docs/03-features/016-child-app/021-monitoring.md",tags:[],version:"current",sidebarPosition:21,frontMatter:{},sidebar:"sidebar",previous:{title:"Known Issues",permalink:"/docs/features/child-app/known-issues"},next:{title:"Papi (API Routes)",permalink:"/docs/features/papi"}},p={},s=[{value:"Child App Lifecycle Plugins",id:"child-app-lifecycle-plugins",level:2},{value:"Overview",id:"overview",level:3},{value:"Hook Groups and Tokens",id:"hook-groups-and-tokens",level:3},{value:"Preload &amp; Prefetch Hooks",id:"preload--prefetch-hooks",level:3},{value:"Example: Logging Preload and Prefetch Events",id:"example-logging-preload-and-prefetch-events",level:4},{value:"Loader Hooks",id:"loader-hooks",level:3},{value:"Example: Retry Logic for Load Failure",id:"example-retry-logic-for-load-failure",level:4},{value:"Config Resolution Hooks",id:"config-resolution-hooks",level:3},{value:"Example: Extend External Config",id:"example-extend-external-config",level:4},{value:"Render Hooks",id:"render-hooks",level:3},{value:"Example: Logging Mount Events",id:"example-logging-mount-events",level:4},{value:"Summary",id:"summary",level:3}],d={toc:s};function u({components:e,...n}){return(0,l.kt)("wrapper",(0,a.Z)({},d,n,{components:e,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"child-app-lifecycle-plugins"},"Child App Lifecycle Plugins"),(0,l.kt)("p",null,"This document describes how to monitor the lifecycle of child-apps using dedicated lifecycle plugins. These plugins allow developers to observe, log, and extend child-app behavior at key stages \u2014 such as loading, mounting, and prefetching \u2014 providing a centralized mechanism for child-app monitoring and integration."),(0,l.kt)("h3",{id:"overview"},"Overview"),(0,l.kt)("p",null,"The system provides a set of plugin tokens through which you can observe and extend the lifecycle of child-apps. These plugins receive a ",(0,l.kt)("inlineCode",{parentName:"p"},"hooks")," object with Tapable hook instances that can be wrapped to track or customize behavior during stages such as preload, load, mount, and configuration."),(0,l.kt)("p",null,"These plugins are suitable for advanced use cases such as:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Observing and logging lifecycle events (e.g., preload, prefetch, mount)"),(0,l.kt)("li",{parentName:"ul"},"Extending child-app configuration resolution"),(0,l.kt)("li",{parentName:"ul"},"Retrying loading logic"),(0,l.kt)("li",{parentName:"ul"},"Measuring render performance")),(0,l.kt)("hr",null),(0,l.kt)("h3",{id:"hook-groups-and-tokens"},"Hook Groups and Tokens"),(0,l.kt)("p",null,"Hooks are grouped and exposed through the following plugin tokens:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"CHILD_APP_PRELOAD_MANAGER_PLUGIN"),": Hooks related to preload, prefetch behavior, and command line execution"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"CHILD_APP_LOADER_PLUGIN"),": Hooks related to loading the child-app assets (JS, CSS and stats JSON files)"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"CHILD_APP_CONFIG_RESOLUTION_PLUGIN"),": Hooks related to resolving external configuration for child-apps"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"CHILD_APP_RENDER_PLUGIN"),": Hooks related to rendering and mount status")),(0,l.kt)("hr",null),(0,l.kt)("h3",{id:"preload--prefetch-hooks"},"Preload & Prefetch Hooks"),(0,l.kt)("p",null,"Token: ",(0,l.kt)("inlineCode",{parentName:"p"},"CHILD_APP_PRELOAD_MANAGER_PLUGIN")),(0,l.kt)("p",null,"Hooks available:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Hook Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"preloadChildApp"),(0,l.kt)("td",{parentName:"tr",align:null},"AsyncTapableHook"),(0,l.kt)("td",{parentName:"tr",align:null},"Fires when a child-app is preloaded")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"prefetchChildApp"),(0,l.kt)("td",{parentName:"tr",align:null},"AsyncTapableHook"),(0,l.kt)("td",{parentName:"tr",align:null},"Fires when a child-app is prefetched")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"runChildAppCommandLine"),(0,l.kt)("td",{parentName:"tr",align:null},"AsyncTapableHook"),(0,l.kt)("td",{parentName:"tr",align:null},"Fires when a child-app command-line is executed")))),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"export type RunChildAppCommandLineArgs = {\n  config: ChildAppFinalConfig;\n  status: string; // possible values: customer, clear\n  line: keyof CommandLines; // possible values: server, client\n};\n\nexport type ChildAppPreloadHooks = {\n  preloadChildApp: AsyncTapableHookInstance<PreloadArgs, undefined | ChildAppFinalConfig>;\n  prefetchChildApp: AsyncTapableHookInstance<PreloadArgs>;\n  runChildAppCommandLine: AsyncTapableHookInstance<RunChildAppCommandLineArgs>;\n};\n")),(0,l.kt)("h4",{id:"example-logging-preload-and-prefetch-events"},"Example: Logging Preload and Prefetch Events"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"import { LOGGER_TOKEN } from '@tramvai/tokens-common';\n\nexport const logPreloadPlugin = {\n  provide: CHILD_APP_PRELOAD_MANAGER_PLUGIN,\n  useFactory: ({ logger }) => {\n    const log = logger('child-app:preload');\n\n    return {\n      apply(hooks) {\n        hooks.preloadChildApp.wrap(async (_, payload, next) => {\n          log.info({ event: 'child-app-preload', name: payload.config.name });\n          return next(payload);\n        });\n\n        hooks.prefetchChildApp.wrap(async (_, payload, next) => {\n          log.info({ event: 'child-app-prefetch', name: payload.config.name });\n          return next(payload);\n        });\n\n        hooks.runChildAppCommandLine.wrap(async (_, payload, next) => {\n          // example: log customer line on server\n          if (payload.status === 'customer' && typeof window === 'undefined') {\n            log.info({ event: 'child-app-customer-command-line-run', name: payload.config.name });\n          }\n\n          const result = await next(payload);\n          return result;\n        });\n      },\n    };\n  },\n  deps: {\n    logger: LOGGER_TOKEN,\n  },\n};\n")),(0,l.kt)("hr",null),(0,l.kt)("h3",{id:"loader-hooks"},"Loader Hooks"),(0,l.kt)("p",null,"Token: ",(0,l.kt)("inlineCode",{parentName:"p"},"CHILD_APP_LOADER_PLUGIN")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Note: Plugins registered under CHILD_APP_LOADER_PLUGIN must use Scope.SINGLETON. This is because the loader itself operates as a singleton and the plugin must match that scope to function correctly. Registering it with another scope may lead to unexpected behavior.")),(0,l.kt)("p",null,"Hooks available:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Hook Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"loadModule"),(0,l.kt)("td",{parentName:"tr",align:null},"AsyncTapableHook"),(0,l.kt)("td",{parentName:"tr",align:null},"Fires when a child-app module is being loaded")))),(0,l.kt)("h4",{id:"example-retry-logic-for-load-failure"},"Example: Retry Logic for Load Failure"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"export const retryLoadPlugin = {\n  provide: CHILD_APP_LOADER_PLUGIN,\n  scope: Scope.SINGLETON,\n  useFactory: () => {\n    return {\n      apply(hooks) {\n        hooks.loadModule.wrap(async (_, payload, next) => {\n          let attempts = 0;\n          const maxAttempts = 3;\n\n          while (attempts < maxAttempts) {\n            try {\n              return await next(payload);\n            } catch (error) {\n              attempts++;\n              if (attempts >= maxAttempts) throw error;\n              await new Promise((resolve) => setTimeout(resolve, 1000));\n            }\n          }\n        });\n      },\n    };\n  },\n};\n")),(0,l.kt)("hr",null),(0,l.kt)("h3",{id:"config-resolution-hooks"},"Config Resolution Hooks"),(0,l.kt)("p",null,"Token: ",(0,l.kt)("inlineCode",{parentName:"p"},"CHILD_APP_CONFIG_RESOLUTION_PLUGIN")),(0,l.kt)("p",null,"Hooks available:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Hook Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"fetchConfig"),(0,l.kt)("td",{parentName:"tr",align:null},"AsyncTapableHook"),(0,l.kt)("td",{parentName:"tr",align:null},"Fires when resolving external config for a child-app")))),(0,l.kt)("h4",{id:"example-extend-external-config"},"Example: Extend External Config"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"export const extendConfigPlugin = {\n  provide: CHILD_APP_CONFIG_RESOLUTION_PLUGIN,\n  useFactory: () => {\n    return {\n      apply(hooks) {\n        hooks.fetchConfig.wrap(async (_, payload, next) => {\n          const [original, extension] = await Promise.all([next(payload), fetchExtraConfig()]);\n\n          return [...original, ...extension];\n        });\n      },\n    };\n  },\n};\n")),(0,l.kt)("hr",null),(0,l.kt)("h3",{id:"render-hooks"},"Render Hooks"),(0,l.kt)("p",null,"Token: ",(0,l.kt)("inlineCode",{parentName:"p"},"CHILD_APP_RENDER_PLUGIN")),(0,l.kt)("p",null,"Hooks available:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Hook Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"mounted"),(0,l.kt)("td",{parentName:"tr",align:null},"SyncTapableHook"),(0,l.kt)("td",{parentName:"tr",align:null},"Fires after the child-app is mounted on the client")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"mountFailed"),(0,l.kt)("td",{parentName:"tr",align:null},"SyncTapableHook"),(0,l.kt)("td",{parentName:"tr",align:null},"Fires after fallback is mounted on error")))),(0,l.kt)("h4",{id:"example-logging-mount-events"},"Example: Logging Mount Events"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"import { LOGGER_TOKEN } from '@tramvai/tokens-common';\n\nexport const logRenderPlugin = {\n  provide: CHILD_APP_RENDER_PLUGIN,\n  useFactory: ({ logger }) => {\n    const log = logger('child-app:render');\n\n    return {\n      apply(hooks) {\n        hooks.mounted.tap('logMounted', ({ name, version, tag }) => {\n          log.info({ event: 'child-app-mounted', name, version, tag });\n        });\n\n        hooks.mountFailed.tap('logMountFailed', ({ name, version, tag }) => {\n          log.error({ event: 'child-app-mount-failed', name, version, tag });\n        });\n      },\n    };\n  },\n  deps: {\n    logger: LOGGER_TOKEN,\n  },\n};\n")),(0,l.kt)("hr",null),(0,l.kt)("h3",{id:"summary"},"Summary"),(0,l.kt)("p",null,"To extend the behavior of child-apps throughout their lifecycle:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Implement a plugin object with an ",(0,l.kt)("inlineCode",{parentName:"li"},"apply(hooks)")," method"),(0,l.kt)("li",{parentName:"ol"},"Use ",(0,l.kt)("inlineCode",{parentName:"li"},".wrap")," for async hooks and ",(0,l.kt)("inlineCode",{parentName:"li"},".tap")," for sync hooks"),(0,l.kt)("li",{parentName:"ol"},"Register your plugin under the appropriate token with ",(0,l.kt)("inlineCode",{parentName:"li"},"multi: true"))),(0,l.kt)("hr",null))}u.isMDXComponent=!0}}]);