"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[9823],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),s=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=s(e.components);return a.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,c=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),m=s(n),d=r,h=m["".concat(c,".").concat(d)]||m[d]||p[d]||o;return n?a.createElement(h,l(l({ref:t},u),{},{components:n})):a.createElement(h,l({ref:t},u))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,l=new Array(o);l[0]=m;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:r,l[1]=i;for(var s=2;s<o;s++)l[s]=n[s];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5162:(e,t,n)=>{n.d(t,{Z:()=>l});var a=n(7294),r=n(6010);const o="tabItem_Ymn6";function l({children:e,hidden:t,className:n}){return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(o,n),hidden:t},e)}},4866:(e,t,n)=>{n.d(t,{Z:()=>N});var a=n(7462),r=n(7294),o=n(6010),l=n(2466),i=n(6550),c=n(1980),s=n(7392),u=n(12);function p(e){return function(e){return r.Children.map(e,(e=>{if((0,r.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))}(e).map((({props:{value:e,label:t,attributes:n,default:a}})=>({value:e,label:t,attributes:n,default:a})))}function m(e){const{values:t,children:n}=e;return(0,r.useMemo)((()=>{const e=t??p(n);return function(e){const t=(0,s.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function d({value:e,tabValues:t}){return t.some((t=>t.value===e))}function h({queryString:e=!1,groupId:t}){const n=(0,i.k6)(),a=function({queryString:e=!1,groupId:t}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:e,groupId:t});return[(0,c._X)(a),(0,r.useCallback)((e=>{if(!a)return;const t=new URLSearchParams(n.location.search);t.set(a,e),n.replace({...n.location,search:t.toString()})}),[a,n])]}function v(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,o=m(e),[l,i]=(0,r.useState)((()=>function({defaultValue:e,tabValues:t}){if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!d({value:e,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const n=t.find((e=>e.default))??t[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:t,tabValues:o}))),[c,s]=h({queryString:n,groupId:a}),[p,v]=function({groupId:e}){const t=function(e){return e?`docusaurus.tab.${e}`:null}(e),[n,a]=(0,u.Nk)(t);return[n,(0,r.useCallback)((e=>{t&&a.set(e)}),[t,a])]}({groupId:a}),k=(()=>{const e=c??p;return d({value:e,tabValues:o})?e:null})();(0,r.useLayoutEffect)((()=>{k&&i(k)}),[k]);return{selectedValue:l,selectValue:(0,r.useCallback)((e=>{if(!d({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);i(e),s(e),v(e)}),[s,v,o]),tabValues:o}}var k=n(2389);const g="tabList__CuJ",f="tabItem_LNqP";function b({className:e,block:t,selectedValue:n,selectValue:i,tabValues:c}){const s=[],{blockElementScrollPositionUntilNextRender:u}=(0,l.o5)(),p=e=>{const t=e.currentTarget,a=s.indexOf(t),r=c[a].value;r!==n&&(u(t),i(r))},m=e=>{let t=null;switch(e.key){case"Enter":p(e);break;case"ArrowRight":{const n=s.indexOf(e.currentTarget)+1;t=s[n]??s[0];break}case"ArrowLeft":{const n=s.indexOf(e.currentTarget)-1;t=s[n]??s[s.length-1];break}}t?.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.Z)("tabs",{"tabs--block":t},e)},c.map((({value:e,label:t,attributes:l})=>r.createElement("li",(0,a.Z)({role:"tab",tabIndex:n===e?0:-1,"aria-selected":n===e,key:e,ref:e=>s.push(e),onKeyDown:m,onClick:p},l,{className:(0,o.Z)("tabs__item",f,l?.className,{"tabs__item--active":n===e})}),t??e))))}function y({lazy:e,children:t,selectedValue:n}){if(t=Array.isArray(t)?t:[t],e){const e=t.find((e=>e.props.value===n));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},t.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==n}))))}function w(e){const t=v(e);return r.createElement("div",{className:(0,o.Z)("tabs-container",g)},r.createElement(b,(0,a.Z)({},e,t)),r.createElement(y,(0,a.Z)({},e,t)))}function N(e){const t=(0,k.Z)();return r.createElement(w,(0,a.Z)({key:String(t)},e))}},6725:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>c,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>p});var a=n(7462),r=(n(7294),n(3905)),o=n(4866),l=n(5162);const i={id:"react-compiler",title:"React Compiler"},c=void 0,s={unversionedId:"guides/react-compiler",id:"guides/react-compiler",title:"React Compiler",description:"Overview",source:"@site/tmp-docs/guides/react-compiler.md",sourceDirName:"guides",slug:"/guides/react-compiler",permalink:"/docs/guides/react-compiler",draft:!1,editUrl:"https://github.com/tramvaijs/tramvai/-/edit/master/docs/tmp-docs/guides/react-compiler.md",tags:[],version:"current",frontMatter:{id:"react-compiler",title:"React Compiler"},sidebar:"sidebar",previous:{title:"React 18 features",permalink:"/docs/guides/react-18"},next:{title:"Server optimization",permalink:"/docs/guides/server-optimization"}},u={},p=[{value:"Overview",id:"overview",level:2},{value:"Usage",id:"usage",level:2},{value:"Adoption",id:"adoption",level:2},{value:"Unsupported cases",id:"unsupported-cases",level:3},{value:"usePageService/useRoute",id:"usepageserviceuseroute",level:4},{value:"How to",id:"how-to",level:2},{value:"Watch the influence",id:"watch-the-influence",level:3},{value:"Opting out of React Compiler",id:"opting-out-of-react-compiler",level:3},{value:"Options",id:"options",level:2},{value:"<code>sources</code>",id:"sources",level:3},{value:"<code>compilationMode</code>",id:"compilationmode",level:3},{value:"infer (default)",id:"infer-default",level:4},{value:"annotation",id:"annotation",level:4},{value:"all",id:"all",level:4},{value:"<code>panicThreshold</code>",id:"panicthreshold",level:3},{value:"none (default)",id:"none-default",level:4},{value:"critical_errors",id:"critical_errors",level:4},{value:"all_errors&#39;,",id:"all_errors",level:4},{value:"Source links",id:"source-links",level:2}],m={toc:p};function d({components:e,...t}){return(0,r.kt)("wrapper",(0,a.Z)({},m,t,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,"React Compiler (aka Forget) \u2013 is a tool developed by the React core team, that takes the original components code, and tries to convert it into code where components, their props, and hooks dependencies are memoized by default. The main purpose of React Compiler is to allow developers do not think about memoization, e.g. using ",(0,r.kt)("inlineCode",{parentName:"p"},"React.memo"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"useMemo"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"useCallback"),", which can be very difficult to do correctly."),(0,r.kt)("p",null,"Essentially React Compiler is a Babel plugin, that transforms source code. Tramvai provides an integration with React Compiler out of the box."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},":::note")),(0,r.kt)("p",null,"Though we are observing up to 20% increased client render performance in some cases, React Compiler is still experimental tool, so use it carefully."),(0,r.kt)("p",null,":::"),(0,r.kt)("h2",{id:"usage"},"Usage"),(0,r.kt)("p",null,"First, enable React Compiler in ",(0,r.kt)("inlineCode",{parentName:"p"},"tramvai.json"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "experiments": {\n    "reactCompiler": true\n  }\n}\n')),(0,r.kt)("p",null,"Second, install ",(0,r.kt)("inlineCode",{parentName:"p"},"babel-plugin-react-compiler"),":"),(0,r.kt)(o.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,r.kt)(l.Z,{value:"npm",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"npm i --save-dev babel-plugin-react-compiler@beta\n"))),(0,r.kt)(l.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"yarn i --save-dev babel-plugin-react-compiler@beta\n# couldn't auto-convert command\n")))),(0,r.kt)("p",null,"Also, if you are using React 18 or below, you need to install ",(0,r.kt)("inlineCode",{parentName:"p"},"react-compiler-runtime"),":"),(0,r.kt)(o.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,r.kt)(l.Z,{value:"npm",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"npm i --save react-compiler-runtime@beta\n"))),(0,r.kt)(l.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"yarn i --save react-compiler-runtime@beta\n# couldn't auto-convert command\n")))),(0,r.kt)("p",null,"That's it! After that, your source code will be transformed by React Compiler."),(0,r.kt)("h2",{id:"adoption"},"Adoption"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"React compiler is an experimental tool, so we recommend to use it gradually. First of all, check your codebase for readiness for React Compiler:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-npm"},"npx react-compiler-healthcheck\n")),(0,r.kt)("p",null,"It will display summary about your project and changes, that will be made by React Compiler."),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Second, install ESLint plugin, to check specific places in your code which can not be handled by React Compiler:")),(0,r.kt)(o.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,r.kt)(l.Z,{value:"npm",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"npm i --save-dev eslint-plugin-react-compile\n"))),(0,r.kt)(l.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"yarn i --save-dev eslint-plugin-react-compile\n# couldn't auto-convert command\n")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-eslintrc.js"},"module.exports = {\n  plugins: [\n    'eslint-plugin-react-compiler',\n  ],\n  rules: {\n    'react-compiler/react-compiler': 'error',\n  },\n}\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Determine small folders, where you can apply React Compiler and use in ",(0,r.kt)("inlineCode",{parentName:"li"},"tramvai.json"),":")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"experiments": {\n  "reactCompiler": {\n    "sources": ["src/catalogs"]\n  }\n}\n')),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Test your changes carefully. When you have more confidence with rolling out the compiler, you can expand coverage to other directories as well and slowly roll it out to your whole app.")),(0,r.kt)("h3",{id:"unsupported-cases"},"Unsupported cases"),(0,r.kt)("h4",{id:"usepageserviceuseroute"},"usePageService/useRoute"),(0,r.kt)("p",null,"Essentially React Compiler relies on variable references. In terms of Tramvai it means that anything coming from DI, will be broken by React Compiler optimizations. For example, this code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-tsx"},"export const Footer = () => {\n  const pageService = usePageService();\n  const ModalComponent = pageService.getComponent('modal');\n\n  return (\n    <div className={styles.footer}>\n      <div>this Footer in fs-routing</div>\n\n      {ModalComponent !== undefined && <ModalComponent />}\n    </div>\n  );\n};\n")),(0,r.kt)("p",null,"will be transformed into:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-tsx"},"import { c as _c } from 'react/compiler-runtime';\n\nexport const Footer = () => {\n  const $ = _c(7);\n  const pageService = usePageService();\n\n  let t0;\n  if ($[0] !== pageService) {\n    t0 = pageService.getComponent('modal');\n    $[0] = pageService;\n    $[1] = t0;\n  } else {\n    t0 = $[1];\n  }\n  const ModalComponent = t0;\n\n  // ...\n};\n")),(0,r.kt)("p",null,'How you can see, now component will not re-render during route change. The only way to fix it is to add "use no memo" directive to Footer:'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-tsx"},"export const Footer = () => {\n  'use no memo';\n\n  // ...\n};\n")),(0,r.kt)("h2",{id:"how-to"},"How to"),(0,r.kt)("h3",{id:"watch-the-influence"},"Watch the influence"),(0,r.kt)("p",null,"React DevTools (v5.0+) have built-in support for React Compiler and will display a \u201cMemo \u2728\u201d badge next to components that have been optimized by the compiler."),(0,r.kt)("p",null,"Also, if you are interested with what exactly compiler does with your code, you can visit ",(0,r.kt)("a",{parentName:"p",href:"https://playground.react.dev/"},"React Compiler Playground"),"."),(0,r.kt)("h3",{id:"opting-out-of-react-compiler"},"Opting out of React Compiler"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Specify directories, where you want to enable React Compiler via ",(0,r.kt)("inlineCode",{parentName:"li"},"tramvai.json"),":")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"experiments": {\n  "reactCompiler": {\n    "sources": ["src/catalogs"]\n  }\n}\n')),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},'Use "use no memo" directive. It\'s also works with hooks:')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-tsx"},"function SuspiciousComponent() {\n  'use no memo'; // opts out this component from being compiled by React Compiler\n  // ...\n}\n")),(0,r.kt)("p",null,"::: note"),(0,r.kt)("p",null,"It is not recommended to reach for this directive unless it\u2019s strictly necessary. Once you opt-out a component or hook, it is opted-out forever until the directive is removed. This means that even if you fix the code, the compiler will still skip over compiling it unless you remove the directive."),(0,r.kt)("p",null,":::"),(0,r.kt)("h2",{id:"options"},"Options"),(0,r.kt)("h3",{id:"sources"},(0,r.kt)("inlineCode",{parentName:"h3"},"sources")),(0,r.kt)("p",null,"Array of paths which React compiler applies to. Ignore node_modules by default."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"experiments": {\n  "reactCompiler": {\n    "sources": ["src/catalogs"]\n  }\n}\n')),(0,r.kt)("h3",{id:"compilationmode"},(0,r.kt)("inlineCode",{parentName:"h3"},"compilationMode")),(0,r.kt)("p",null,"Determines the strategy for determining which functions to compile."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"experiments": {\n  "reactCompiler": {\n    "compilationMode": "annotation"\n  }\n}\n')),(0,r.kt)("h4",{id:"infer-default"},"infer (default)"),(0,r.kt)("p",null,"React Compiler handles next cases:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},'Functions, annotated with "use forget" directive;'),(0,r.kt)("li",{parentName:"ul"},"Components declared with component syntax;"),(0,r.kt)("li",{parentName:"ul"},"Functions which can be inferred to be a component or hook: be named like a hook or component (this logic matches the ESLint rule) ",(0,r.kt)("em",{parentName:"li"},"and")," create JSX and/or call a hook;")),(0,r.kt)("h4",{id:"annotation"},"annotation"),(0,r.kt)("p",null,'Compile only functions which are explicitly annotated with "use forget" annotation.'),(0,r.kt)("h4",{id:"all"},"all"),(0,r.kt)("p",null,"Compile all top-level functions."),(0,r.kt)("h3",{id:"panicthreshold"},(0,r.kt)("inlineCode",{parentName:"h3"},"panicThreshold")),(0,r.kt)("p",null,"Determines the point at which compiler should throw an error."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"experiments": {\n  "reactCompiler": {\n    "panicThreshold": "critical_errors"\n  }\n}\n')),(0,r.kt)("h4",{id:"none-default"},"none (default)"),(0,r.kt)("p",null,"Never panic by throwing an exception."),(0,r.kt)("h4",{id:"critical_errors"},"critical_errors"),(0,r.kt)("p",null,"Panic by throwing an exception only on critical or unrecognized errors. For all other errors, skip the erroring function without inserting a compiled version."),(0,r.kt)("h4",{id:"all_errors"},"all_errors',"),(0,r.kt)("p",null,"Any errors will panic the compiler by throwing an exception, which will break the build."),(0,r.kt)("h2",{id:"source-links"},"Source links"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://react.dev/learn/react-compiler"},"React Compiler overview")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.developerway.com/posts/i-tried-react-compiler"},"Friendly explanation about compiler usage"))))}d.isMDXComponent=!0}}]);